---
// Global search component that searches across all content
---
  
  <!-- Search Modal -->
  <div id="global-search-modal" class="fixed inset-0 z-50 hidden">
    <!-- Backdrop -->
    <div class="fixed inset-0 bg-black/50 backdrop-blur-sm" id="search-backdrop"></div>
    
    <!-- Modal Content -->
    <div class="fixed inset-x-4 top-20 max-w-2xl mx-auto">
      <div class="bg-slate-900 border border-slate-700 rounded-xl shadow-2xl overflow-hidden">
        <!-- Search Input -->
        <div class="flex items-center gap-3 p-4 border-b border-slate-800">
          <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
          </svg>
          <input
            type="text"
            id="global-search-input"
            placeholder="Search documentation, blog posts, tools..."
            class="flex-1 bg-transparent text-white placeholder-slate-400 focus:outline-none"
            autocomplete="off"
          />
          <button
            id="search-close"
            class="p-1 text-slate-400 hover:text-white transition-colors"
            aria-label="Close search"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
        
        <!-- Search Results -->
        <div id="search-results" class="max-h-96 overflow-y-auto">
          <!-- Initial State -->
          <div class="p-8 text-center text-slate-400" id="search-initial">
            <svg class="w-12 h-12 mx-auto mb-4 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
            </svg>
            <p>Start typing to search across all content</p>
            <p class="text-sm text-slate-500 mt-2">Try searching for "authentication", "OAuth", or "Model Derivative"</p>
          </div>
          
          <!-- Loading State -->
          <div class="p-8 text-center text-slate-400 hidden" id="search-loading">
            <div class="inline-flex items-center gap-2">
              <svg class="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              Searching...
            </div>
          </div>
          
          <!-- Results Container -->
          <div id="search-results-container" class="hidden"></div>
          
          <!-- No Results -->
          <div class="p-8 text-center text-slate-400 hidden" id="search-no-results">
            <svg class="w-12 h-12 mx-auto mb-4 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <p>No results found</p>
            <p class="text-sm text-slate-500 mt-2">Try different keywords or check your spelling</p>
          </div>
        </div>
        
        <!-- Footer -->
        <div class="flex items-center justify-between p-3 border-t border-slate-800 text-xs text-slate-500">
          <div class="flex items-center gap-4">
            <span class="flex items-center gap-1">
              <kbd class="px-1.5 py-0.5 bg-slate-800 rounded">↑↓</kbd> Navigate
            </span>
            <span class="flex items-center gap-1">
              <kbd class="px-1.5 py-0.5 bg-slate-800 rounded">↵</kbd> Open
            </span>
            <span class="flex items-center gap-1">
              <kbd class="px-1.5 py-0.5 bg-slate-800 rounded">ESC</kbd> Close
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Search index - optimized for performance
  const searchIndex = [
    // Core docs
    { title: 'Installation', type: 'docs', url: '/docs/installation', content: 'Install RAPS', tags: ['install', 'setup'] },
    { title: 'Configuration', type: 'docs', url: '/docs/configuration', content: 'Setup credentials', tags: ['config', 'auth'] },
    { title: 'Authentication', type: 'docs', url: '/docs/auth', content: 'OAuth flows', tags: ['oauth', 'token'] },
    { title: 'Translation', type: 'docs', url: '/docs/translation', content: 'Convert CAD files', tags: ['convert', 'cad'] },
    { title: 'GitHub Actions', type: 'docs', url: '/docs/mode-github-actions', content: 'CI/CD integration', tags: ['ci', 'pipeline'] },
    
    // Tools
    { title: 'OAuth Scope Builder', type: 'tool', url: '/tools/scope-builder', content: 'Build scopes', tags: ['oauth', 'scope'] },
    { title: 'Token Decoder', type: 'tool', url: '/tools/token-decoder', content: 'Decode tokens', tags: ['jwt', 'debug'] },
    { title: 'URN Encoder', type: 'tool', url: '/tools/urn-encoder', content: 'Encode URNs', tags: ['urn', 'encode'] },
    
    // Pages  
    { title: 'Quick Start', type: 'page', url: '/quickstart', content: 'Get started', tags: ['start', 'guide'] },
    { title: 'Roadmap', type: 'page', url: '/roadmap', content: 'Future features', tags: ['roadmap'] },
    { title: 'APS Hierarchy', type: 'page', url: '/resources/aps-hierarchy', content: 'Visual service map', tags: ['hierarchy', 'visual', 'architecture'] },
  ];
  
  // Search functionality
  const modal = document.getElementById('global-search-modal');
  const backdrop = document.getElementById('search-backdrop');
  const closeBtn = document.getElementById('search-close');
  const input = document.getElementById('global-search-input');
  const resultsContainer = document.getElementById('search-results-container');
  const initialState = document.getElementById('search-initial');
  const loadingState = document.getElementById('search-loading');
  const noResultsState = document.getElementById('search-no-results');
  
  let selectedIndex = -1;
  let searchResults = [];
  
  // Open search modal
  function openSearch() {
    modal?.classList.remove('hidden');
    input?.focus();
    document.body.style.overflow = 'hidden';
  }
  
  // Close search modal
  function closeSearch() {
    modal?.classList.add('hidden');
    input.value = '';
    resultsContainer.innerHTML = '';
    resultsContainer.classList.add('hidden');
    initialState?.classList.remove('hidden');
    noResultsState?.classList.add('hidden');
    selectedIndex = -1;
    searchResults = [];
    document.body.style.overflow = '';
  }
  
  // Perform search
  function performSearch(query) {
    if (!query) {
      resultsContainer.innerHTML = '';
      resultsContainer.classList.add('hidden');
      initialState?.classList.remove('hidden');
      noResultsState?.classList.add('hidden');
      return;
    }
    
    const lowerQuery = query.toLowerCase();
    searchResults = searchIndex.filter(item => {
      const inTitle = item.title.toLowerCase().includes(lowerQuery);
      const inContent = item.content.toLowerCase().includes(lowerQuery);
      const inTags = item.tags.some(tag => tag.includes(lowerQuery));
      return inTitle || inContent || inTags;
    });
    
    // Sort results by relevance
    searchResults.sort((a, b) => {
      const aTitle = a.title.toLowerCase().includes(lowerQuery) ? 2 : 0;
      const bTitle = b.title.toLowerCase().includes(lowerQuery) ? 2 : 0;
      const aExact = a.title.toLowerCase() === lowerQuery ? 3 : 0;
      const bExact = b.title.toLowerCase() === lowerQuery ? 3 : 0;
      return (bExact + bTitle) - (aExact + aTitle);
    });
    
    displayResults(searchResults);
  }
  
  // Display search results
  function displayResults(results) {
    initialState?.classList.add('hidden');
    
    if (results.length === 0) {
      noResultsState?.classList.remove('hidden');
      resultsContainer.classList.add('hidden');
      return;
    }
    
    noResultsState?.classList.add('hidden');
    resultsContainer.classList.remove('hidden');
    
    const grouped = {};
    results.forEach(result => {
      if (!grouped[result.type]) grouped[result.type] = [];
      grouped[result.type].push(result);
    });
    
    let html = '';
    const typeLabels = {
      docs: 'Documentation',
      tool: 'Tools',
      blog: 'Blog',
      page: 'Pages'
    };
    
    Object.entries(grouped).forEach(([type, items]) => {
      html += `
        <div class="border-b border-slate-800 last:border-0">
          <div class="px-4 py-2 text-xs font-semibold text-slate-500 uppercase tracking-wider">
            ${typeLabels[type] || type}
          </div>
          ${items.map((item, index) => `
            <a href="${item.url}" class="search-result block px-4 py-3 hover:bg-slate-800 transition-colors" data-index="${searchResults.indexOf(item)}">
              <div class="flex items-center justify-between">
                <div class="flex-1">
                  <div class="font-medium text-white">${highlightMatch(item.title, input.value)}</div>
                  <div class="text-sm text-slate-400 mt-1">${highlightMatch(item.content, input.value)}</div>
                </div>
                <svg class="w-4 h-4 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
              </div>
            </a>
          `).join('')}
        </div>
      `;
    });
    
    resultsContainer.innerHTML = html;
    selectedIndex = -1;
  }
  
  // Highlight matching text
  function highlightMatch(text, query) {
    if (!query) return text;
    const regex = new RegExp(`(${query})`, 'gi');
    return text.replace(regex, '<mark class="bg-rapeseed-500/30 text-rapeseed-300">$1</mark>');
  }
  
  // Keyboard navigation
  function navigateResults(direction) {
    const results = resultsContainer.querySelectorAll('.search-result');
    if (results.length === 0) return;
    
    // Remove previous selection
    if (selectedIndex >= 0) {
      results[selectedIndex]?.classList.remove('bg-slate-800');
    }
    
    // Update index
    if (direction === 'down') {
      selectedIndex = (selectedIndex + 1) % results.length;
    } else {
      selectedIndex = selectedIndex <= 0 ? results.length - 1 : selectedIndex - 1;
    }
    
    // Add new selection
    results[selectedIndex]?.classList.add('bg-slate-800');
    results[selectedIndex]?.scrollIntoView({ block: 'nearest' });
  }
  
  // Event listeners
  backdrop?.addEventListener('click', closeSearch);
  closeBtn?.addEventListener('click', closeSearch);
  
  // Mount search button in header if present
  const headerSearchContainer = document.getElementById('header-search');
  if (headerSearchContainer) {
    const searchButton = document.createElement('button');
    searchButton.id = 'global-search-trigger';
    searchButton.className = 'flex items-center gap-2 px-3 py-1.5 bg-slate-800 hover:bg-slate-700 text-slate-300 hover:text-white rounded-lg transition-colors text-sm';
    searchButton.setAttribute('aria-label', 'Search');
    searchButton.innerHTML = `
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
      </svg>
      <span class="hidden lg:inline">Search</span>
      <kbd class="hidden lg:inline-flex items-center gap-0.5 px-1.5 py-0.5 bg-slate-700 rounded text-xs text-slate-400">
        <span>⌘</span><span>K</span>
      </kbd>
    `;
    headerSearchContainer.appendChild(searchButton);
    searchButton.addEventListener('click', openSearch);
  }
  
  // Search input
  input?.addEventListener('input', (e) => {
    performSearch(e.target.value);
  });
  
  // Keyboard shortcuts
  document.addEventListener('keydown', (e) => {
    // Open with Cmd/Ctrl + K
    if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
      e.preventDefault();
      openSearch();
    }
    
    // Close with Escape
    if (e.key === 'Escape' && !modal?.classList.contains('hidden')) {
      closeSearch();
    }
    
    // Navigate with arrow keys
    if (!modal?.classList.contains('hidden')) {
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        navigateResults('down');
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        navigateResults('up');
      } else if (e.key === 'Enter' && selectedIndex >= 0) {
        e.preventDefault();
        const results = resultsContainer.querySelectorAll('.search-result');
        results[selectedIndex]?.click();
      }
    }
  });
</script>

<style>
  .perspective-1000 {
    perspective: 1000px;
  }
  
  .rotate-x-2 {
    transform: rotateX(2deg);
  }
</style>