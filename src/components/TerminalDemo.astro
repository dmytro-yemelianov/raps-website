---
// Animated Terminal Demo Component
// Shows RAPS commands being typed with realistic timing

interface Props {
  class?: string;
}

const { class: className } = Astro.props;

const commands = [
  { type: 'comment', text: '# Install RAPS' },
  { type: 'command', prompt: '$', text: 'cargo install raps', delay: 800 },
  { type: 'output', text: '    Installed package `raps v2.0.0`', delay: 1200 },
  { type: 'comment', text: '# Test authentication' },
  { type: 'command', prompt: '$', text: 'raps auth test', delay: 600 },
  { type: 'output', text: '✓ 2-legged authentication successful', delay: 800 },
  { type: 'comment', text: '# Upload and translate a model' },
  { type: 'command', prompt: '$', text: 'raps object upload my-bucket model.rvt', delay: 1000 },
  { type: 'output', text: 'Uploading model.rvt... ████████████████ 100%', delay: 1500 },
  { type: 'command', prompt: '$', text: 'raps translate start $URN --format svf2 --wait', delay: 1200 },
  { type: 'output', text: '✓ Translation complete in 47s', delay: 2000 },
  { type: 'comment', text: '# Export as JSON for CI/CD' },
  { type: 'command', prompt: '$', text: 'raps translate manifest $URN -o json', delay: 800 },
];
---

<div class:list={["terminal-demo", className]}>
  <div class="bg-slate-900 rounded-xl border border-slate-800 overflow-hidden shadow-2xl">
    <!-- Terminal header -->
    <div class="flex items-center justify-between px-4 py-3 bg-slate-800/50 border-b border-slate-800">
      <div class="flex items-center gap-2">
        <div class="flex gap-1.5">
          <div class="w-3 h-3 rounded-full bg-red-500/80 hover:bg-red-500 transition-colors"></div>
          <div class="w-3 h-3 rounded-full bg-yellow-500/80 hover:bg-yellow-500 transition-colors"></div>
          <div class="w-3 h-3 rounded-full bg-green-500/80 hover:bg-green-500 transition-colors"></div>
        </div>
        <span class="text-sm text-slate-500 ml-2 font-mono">Terminal</span>
      </div>
      <div class="flex items-center gap-2">
        <button 
          id="terminal-restart" 
          class="p-1.5 text-slate-500 hover:text-slate-300 transition-colors rounded hover:bg-slate-700/50"
          title="Restart animation"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg>
        </button>
        <button 
          id="terminal-copy" 
          class="p-1.5 text-slate-500 hover:text-slate-300 transition-colors rounded hover:bg-slate-700/50"
          title="Copy commands"
        >
          <svg class="w-4 h-4 copy-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
          </svg>
          <svg class="w-4 h-4 check-icon hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
          </svg>
        </button>
      </div>
    </div>
    
    <!-- Terminal content -->
    <div id="terminal-content" class="p-6 font-mono text-sm text-left min-h-[320px] overflow-x-auto">
      <!-- Content will be dynamically generated -->
    </div>
  </div>
</div>

<script define:vars={{ commands }}>
  class TerminalAnimation {
    constructor(container, commands) {
      this.container = container;
      this.commands = commands;
      this.currentLine = 0;
      this.isRunning = false;
      this.abortController = null;
    }

    sleep(ms) {
      return new Promise((resolve, reject) => {
        const timeout = setTimeout(resolve, ms);
        if (this.abortController) {
          this.abortController.signal.addEventListener('abort', () => {
            clearTimeout(timeout);
            reject(new Error('Animation aborted'));
          });
        }
      });
    }

    createLine(type) {
      const line = document.createElement('div');
      line.className = 'terminal-line opacity-0 transform translate-y-1';
      
      if (type === 'comment') {
        line.classList.add('text-slate-500', 'mt-4', 'first:mt-0');
      } else if (type === 'command') {
        line.classList.add('text-green-400');
      } else {
        line.classList.add('text-slate-300', 'pl-0');
      }
      
      return line;
    }

    async typeText(element, text, speed = 30) {
      const chars = text.split('');
      for (let i = 0; i < chars.length; i++) {
        if (this.abortController?.signal.aborted) return;
        element.textContent += chars[i];
        await this.sleep(speed + Math.random() * 20);
      }
    }

    async animateLine(cmd) {
      const line = this.createLine(cmd.type);
      this.container.appendChild(line);
      
      // Fade in
      await this.sleep(50);
      line.classList.remove('opacity-0', 'translate-y-1');
      line.classList.add('opacity-100', 'translate-y-0', 'transition-all', 'duration-200');

      if (cmd.type === 'comment') {
        line.textContent = cmd.text;
      } else if (cmd.type === 'command') {
        const prompt = document.createElement('span');
        prompt.className = 'text-green-400';
        prompt.textContent = cmd.prompt + ' ';
        
        const cmdText = document.createElement('span');
        cmdText.className = 'text-white';
        
        const cursor = document.createElement('span');
        cursor.className = 'inline-block w-2 h-4 bg-green-400 ml-0.5 animate-pulse';
        
        line.appendChild(prompt);
        line.appendChild(cmdText);
        line.appendChild(cursor);
        
        await this.typeText(cmdText, cmd.text, 25);
        cursor.remove();
      } else {
        line.textContent = cmd.text;
      }

      await this.sleep(cmd.delay || 300);
    }

    async start() {
      if (this.isRunning) {
        this.stop();
        await this.sleep(100);
      }
      
      this.isRunning = true;
      this.abortController = new AbortController();
      this.container.innerHTML = '';

      try {
        for (const cmd of this.commands) {
          if (this.abortController.signal.aborted) break;
          await this.animateLine(cmd);
        }
        
        // Add blinking cursor at the end
        if (!this.abortController.signal.aborted) {
          const finalLine = document.createElement('div');
          finalLine.className = 'text-green-400 mt-2';
          finalLine.innerHTML = '$ <span class="inline-block w-2 h-4 bg-green-400 ml-0.5 animate-pulse"></span>';
          this.container.appendChild(finalLine);
        }
      } catch (e) {
        // Animation was aborted
      }
      
      this.isRunning = false;
    }

    stop() {
      if (this.abortController) {
        this.abortController.abort();
      }
    }

    getCommands() {
      return this.commands
        .filter(c => c.type === 'command')
        .map(c => c.text)
        .join('\n');
    }
  }

  // Initialize when DOM is ready
  document.addEventListener('DOMContentLoaded', () => {
    const container = document.getElementById('terminal-content');
    const restartBtn = document.getElementById('terminal-restart');
    const copyBtn = document.getElementById('terminal-copy');
    
    if (!container) return;
    
    const terminal = new TerminalAnimation(container, commands);
    
    // Start animation when visible
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting && !terminal.isRunning) {
          terminal.start();
          observer.disconnect();
        }
      });
    }, { threshold: 0.3 });
    
    observer.observe(container);

    // Restart button
    restartBtn?.addEventListener('click', () => {
      terminal.start();
    });

    // Copy button
    copyBtn?.addEventListener('click', async () => {
      const commands = terminal.getCommands();
      await navigator.clipboard.writeText(commands);
      
      const copyIcon = copyBtn.querySelector('.copy-icon');
      const checkIcon = copyBtn.querySelector('.check-icon');
      
      copyIcon?.classList.add('hidden');
      checkIcon?.classList.remove('hidden');
      
      setTimeout(() => {
        copyIcon?.classList.remove('hidden');
        checkIcon?.classList.add('hidden');
      }, 2000);
    });
  });
</script>

<style>
  .terminal-line {
    line-height: 1.6;
  }
</style>

