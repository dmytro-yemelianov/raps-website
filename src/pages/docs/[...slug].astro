---
import DocsLayout from '../../layouts/DocsLayout.astro';
import { getCollection, render, type CollectionEntry } from 'astro:content';
import { stripLocalePrefix, getLangFromUrl, getLocalizedUrl, filterByLocale, localizeEntry } from '../../i18n/utils';

// Helper to get slug from doc, stripping locale prefix
const getDocSlug = (doc: any) => {
  const raw = doc.slug || doc.id || '';
  return stripLocalePrefix(raw.replace(/\.mdx?$/, ''));
};

export async function getStaticPaths() {
  const docs = (await getCollection('docs')).filter(d => d.id.startsWith('en/'));
  return docs.map(doc => {
    const slug = stripLocalePrefix((doc.slug || doc.id || '').replace(/\.mdx?$/, ''));
    return {
      params: { slug },
      props: { doc, slug },
    };
  });
}

interface Props {
  doc: CollectionEntry<'docs'>;
  slug: string;
}

const { doc: enDoc, slug } = Astro.props;
const lang = getLangFromUrl(Astro.url, Astro.currentLocale);
const allDocsRaw = await getCollection('docs');
const doc = localizeEntry(enDoc, allDocsRaw, lang);
const { Content } = await render(doc);

// Get localized docs for navigation
const allDocs = filterByLocale(allDocsRaw, lang);

// Find prev/next in same section
const sectionDocs = allDocs
  .filter(d => d.data.section === doc.data.section)
  .sort((a, b) => a.data.order - b.data.order);
const sectionIndex = sectionDocs.findIndex(d => getDocSlug(d) === slug);
const prevDoc = sectionIndex > 0 ? sectionDocs[sectionIndex - 1] : null;
const nextDoc = sectionIndex < sectionDocs.length - 1 ? sectionDocs[sectionIndex + 1] : null;
---

<DocsLayout
  title={doc.data.title}
  description={doc.data.description}
  currentSlug={slug}
>
  <article class="docs-content">
    <Content />
  </article>

  <!-- Navigation -->
  <nav class="mt-16 pt-8 border-t border-slate-800">
    <div class="flex justify-between gap-4">
      {prevDoc ? (
        <a
          href={getLocalizedUrl(lang, `/docs/${getDocSlug(prevDoc)}`)}
          class="flex-1 group p-4 bg-slate-900/50 border border-slate-800 rounded-lg hover:border-slate-700 transition-colors"
        >
          <div class="text-sm text-slate-500 mb-1">&larr; Previous</div>
          <div class="font-medium text-white group-hover:text-rapeseed-400 transition-colors">
            {prevDoc.data.icon && <span class="mr-2">{prevDoc.data.icon}</span>}
            {prevDoc.data.title}
          </div>
        </a>
      ) : <div class="flex-1"></div>}

      {nextDoc ? (
        <a
          href={getLocalizedUrl(lang, `/docs/${getDocSlug(nextDoc)}`)}
          class="flex-1 group p-4 bg-slate-900/50 border border-slate-800 rounded-lg hover:border-slate-700 transition-colors text-right"
        >
          <div class="text-sm text-slate-500 mb-1">Next &rarr;</div>
          <div class="font-medium text-white group-hover:text-rapeseed-400 transition-colors">
            {nextDoc.data.title}
            {nextDoc.data.icon && <span class="ml-2">{nextDoc.data.icon}</span>}
          </div>
        </a>
      ) : <div class="flex-1"></div>}
    </div>
  </nav>
</DocsLayout>
