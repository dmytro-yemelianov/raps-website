---
import BaseLayout from '../layouts/BaseLayout.astro';
import TerminalGif from '../components/TerminalGif.astro';
import { getLangFromUrl, useTranslations, getLocalizedUrl } from '../i18n/utils';

const lang = getLangFromUrl(Astro.url, Astro.currentLocale);
const t = useTranslations(lang);

const copyTitle = t('quickstart.copy_commands');

const steps = [
  {
    number: '01',
    title: t('quickstart.step1.title'),
    description: t('quickstart.step1.description'),
    tabs: [
      {
        id: 'cargo',
        label: 'Cargo',
        icon: 'ü¶Ä',
        commands: ['cargo install raps'],
        note: t('quickstart.step1.note_cargo'),
      },
      {
        id: 'homebrew',
        label: 'Homebrew',
        icon: 'üç∫',
        commands: [
          '# macOS & Linux',
          'brew install dmytro-yemelianov/tap/raps',
        ],
        note: t('quickstart.step1.note_homebrew'),
      },
      {
        id: 'scoop',
        label: 'Scoop',
        icon: 'ü•Ñ',
        commands: [
          '# Windows',
          'scoop bucket add raps https://github.com/dmytro-yemelianov/scoop-bucket',
          'scoop install raps',
        ],
        note: t('quickstart.step1.note_scoop'),
      },
      {
        id: 'docker',
        label: 'Docker',
        icon: 'üê≥',
        commands: [
          '# DockerHub',
          'docker pull dmytroyemelianov/raps',
          '',
          '# GitHub Container Registry',
          'docker pull ghcr.io/dmytro-yemelianov/raps',
        ],
        note: t('quickstart.step1.note_docker'),
      },
      {
        id: 'action',
        label: 'GitHub Action',
        icon: '‚ö°',
        commands: [
          '# In your .github/workflows/*.yml',
          '- uses: dmytro-yemelianov/raps-action@v1',
          '  with:',
          '    command: "auth test"',
          '    client-id: ${{ secrets.APS_CLIENT_ID }}',
          '    client-secret: ${{ secrets.APS_CLIENT_SECRET }}',
        ],
        note: t('quickstart.step1.note_action'),
      },
      {
        id: 'windows',
        label: 'Windows',
        icon: '‚äû',
        commands: [
          '# Download from GitHub releases',
          'Invoke-WebRequest -Uri "https://github.com/dmytro-yemelianov/raps/releases/latest/download/raps-windows-x64.zip" -OutFile raps.zip',
          'Expand-Archive raps.zip -DestinationPath $env:USERPROFILE\\bin',
          '$env:PATH += ";$env:USERPROFILE\\bin"',
        ],
      },
      {
        id: 'macos',
        label: 'macOS',
        icon: 'üçé',
        commands: [
          '# Apple Silicon',
          'curl -LO https://github.com/dmytro-yemelianov/raps/releases/latest/download/raps-macos-arm64.tar.gz',
          'tar -xzf raps-macos-arm64.tar.gz',
          'sudo mv raps /usr/local/bin/',
        ],
      },
      {
        id: 'linux',
        label: 'Linux',
        icon: 'üêß',
        commands: [
          'curl -LO https://github.com/dmytro-yemelianov/raps/releases/latest/download/raps-linux-x64.tar.gz',
          'tar -xzf raps-linux-x64.tar.gz',
          'sudo mv raps /usr/local/bin/',
          'chmod +x /usr/local/bin/raps',
        ],
      },
    ],
  },
  {
    number: '02',
    title: t('quickstart.step2.title'),
    description: t('quickstart.step2.description'),
    content: `
      <p class="text-slate-400 mb-4">${t('quickstart.step2.get_credentials')} <a href="https://aps.autodesk.com/myapps" target="_blank" rel="noopener noreferrer" class="text-primary-400 hover:text-primary-300 underline">${t('quickstart.step2.aps_portal')}</a>.</p>
      <div class="space-y-4">
        <div class="relative">
          <h4 class="text-sm font-semibold text-white mb-2">${t('quickstart.step2.option1')}</h4>
          <div class="bg-slate-900 rounded-lg border border-slate-800 p-4 font-mono text-sm">
            <div class="text-slate-500"># PowerShell</div>
            <div><span class="text-green-400">$env:</span>APS_CLIENT_ID = <span class="text-amber-400">"your_client_id"</span></div>
            <div><span class="text-green-400">$env:</span>APS_CLIENT_SECRET = <span class="text-amber-400">"your_client_secret"</span></div>
          </div>
          <button class="absolute top-8 right-2 p-1.5 text-slate-500 hover:text-slate-300 transition-colors rounded hover:bg-slate-800/50 copy-content-btn" data-copy-target="option1" title="${copyTitle}">
            <svg class="w-4 h-4 copy-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
            </svg>
            <svg class="w-4 h-4 check-icon hidden text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
          </button>
        </div>
        <div class="relative">
          <h4 class="text-sm font-semibold text-white mb-2">${t('quickstart.step2.option2')}</h4>
          <div class="bg-slate-900 rounded-lg border border-slate-800 p-4 font-mono text-sm">
            <div class="text-slate-500"># ${t('quickstart.step2.option2_comment')}</div>
            <div>APS_CLIENT_ID=your_client_id</div>
            <div>APS_CLIENT_SECRET=your_client_secret</div>
          </div>
          <button class="absolute top-8 right-2 p-1.5 text-slate-500 hover:text-slate-300 transition-colors rounded hover:bg-slate-800/50 copy-content-btn" data-copy-target="option2" title="${copyTitle}">
            <svg class="w-4 h-4 copy-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
            </svg>
            <svg class="w-4 h-4 check-icon hidden text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
          </button>
        </div>
        <div class="relative">
          <h4 class="text-sm font-semibold text-white mb-2">${t('quickstart.step2.option3')}</h4>
          <div class="bg-slate-900 rounded-lg border border-slate-800 p-4 font-mono text-sm">
            <div class="text-green-400">$ <span class="text-white">raps config profile create production</span></div>
            <div class="text-green-400">$ <span class="text-white">raps config set client_id "your_client_id"</span></div>
            <div class="text-green-400">$ <span class="text-white">raps config set client_secret "your_client_secret"</span></div>
          </div>
          <button class="absolute top-8 right-2 p-1.5 text-slate-500 hover:text-slate-300 transition-colors rounded hover:bg-slate-800/50 copy-content-btn" data-copy-target="option3" title="${copyTitle}">
            <svg class="w-4 h-4 copy-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
            </svg>
            <svg class="w-4 h-4 check-icon hidden text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
          </button>
        </div>
      </div>
    `,
  },
  {
    number: '03',
    title: t('quickstart.step3.title'),
    description: t('quickstart.step3.description'),
    code: [
      { prompt: '$', cmd: 'raps auth test', output: '‚úì 2-legged authentication successful' },
      { prompt: '$', cmd: 'raps auth login', output: '‚úì Logged in as john.doe@company.com', note: t('quickstart.step3.note_oauth') },
      { prompt: '$', cmd: 'raps auth whoami', output: 'Name: John Doe\nEmail: john.doe@company.com' },
    ],
  },
  {
    number: '04',
    title: t('quickstart.step4.title'),
    description: t('quickstart.step4.description'),
    code: [
      { prompt: '$', cmd: 'raps bucket create', output: 'Created bucket: my-bucket-abc123' },
      { prompt: '$', cmd: 'raps object upload my-bucket model.rvt', output: 'Uploading model.rvt... ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà 100%\nURN: dXJuOmFkc2sub2...' },
      { prompt: '$', cmd: 'raps translate start $URN --format svf2 --wait', output: 'Translation in progress... done (47s)\n‚úì Translation complete' },
      { prompt: '$', cmd: 'raps translate manifest $URN -o json', output: '{ "status": "success", "derivatives": [...] }' },
    ],
  },
  {
    number: '05',
    title: t('quickstart.step5.title'),
    description: t('quickstart.step5.description'),
    content: `
      <p class="text-slate-400 mb-4">${t('quickstart.step5.intro')}</p>
      <div class="space-y-4">
        <div>
          <h4 class="text-sm font-semibold text-white mb-2">${t('quickstart.step5.claude_desktop')}</h4>
          <pre class="bg-slate-900 rounded-lg border border-slate-800 p-4 font-mono text-sm overflow-x-auto"><code><span class="text-slate-500">// claude_desktop_config.json</span>
{
  <span class="text-amber-400">"mcpServers"</span>: {
    <span class="text-amber-400">"raps"</span>: {
      <span class="text-amber-400">"command"</span>: <span class="text-green-400">"raps"</span>,
      <span class="text-amber-400">"args"</span>: [<span class="text-green-400">"serve"</span>]
    }
  }
}</code></pre>
        </div>
        <div>
          <h4 class="text-sm font-semibold text-white mb-2">${t('quickstart.step5.cursor_ide')}</h4>
          <pre class="bg-slate-900 rounded-lg border border-slate-800 p-4 font-mono text-sm overflow-x-auto"><code><span class="text-slate-500">// .cursor/mcp.json</span>
{
  <span class="text-amber-400">"mcpServers"</span>: {
    <span class="text-amber-400">"raps"</span>: {
      <span class="text-amber-400">"command"</span>: <span class="text-green-400">"raps"</span>,
      <span class="text-amber-400">"args"</span>: [<span class="text-green-400">"serve"</span>]
    }
  }
}</code></pre>
        </div>
        <p class="text-sm text-slate-500 mt-4">${t('quickstart.step5.after_config')} <span class="emoji">ü§ñ</span></p>
      </div>
    `,
  },
];

const nextSteps = [
  { href: getLocalizedUrl(lang, '/docs/usage-modes'), label: t('quickstart.next_steps.usage_modes'), icon: 'üìñ' },
  { href: getLocalizedUrl(lang, '/docs/mode-github-actions'), label: t('quickstart.next_steps.cicd'), icon: 'üîÑ' },
  { href: getLocalizedUrl(lang, '/docs/pipelines'), label: t('quickstart.next_steps.pipelines'), icon: '‚ö°' },
  { href: getLocalizedUrl(lang, '/docs/examples'), label: t('quickstart.next_steps.examples'), icon: 'üìù' },
];
---

<BaseLayout
  title={t('quickstart.title')}
  description={t('quickstart.meta_description')}
>
  <section class="py-16 sm:py-24">
    <div class="max-w-4xl mx-auto px-4 sm:px-6">
      <!-- Header -->
      <div class="mb-16 text-center">
        <div class="inline-flex items-center gap-2 px-4 py-1.5 bg-rapeseed-500/10 border border-rapeseed-500/20 rounded-full text-sm text-rapeseed-400 mb-6">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
          </svg>
          {t('quickstart.badge')}
        </div>
        <h1 class="text-4xl sm:text-5xl font-display font-black text-white mb-6">
          {t('quickstart.heading')}
        </h1>
        <p class="text-xl text-slate-400 max-w-2xl mx-auto">
          {t('quickstart.subtitle')}
        </p>
      </div>

      <!-- Steps -->
      <div class="space-y-16">
        {steps.map((step, index) => (
          <div class="relative">
            {/* Step connector */}
            {index < steps.length - 1 && (
              <div class="absolute left-8 top-20 bottom-0 w-0.5 bg-gradient-to-b from-slate-700 to-transparent hidden md:block"></div>
            )}

            <div class="flex gap-6">
              {/* Step number */}
              <div class="hidden md:flex flex-shrink-0 w-16 h-16 bg-gradient-to-br from-rapeseed-500/20 to-primary-500/20 border border-slate-700 rounded-2xl items-center justify-center">
                <span class="text-2xl font-display font-black text-white">{step.number}</span>
              </div>

              {/* Content */}
              <div class="flex-1">
                <div class="mb-4">
                  <span class="inline-block md:hidden text-sm text-rapeseed-400 font-mono mb-2">{t('quickstart.step_prefix')} {step.number}</span>
                  <h2 class="text-2xl font-display font-bold text-white mb-2">{step.title}</h2>
                  <p class="text-slate-400">{step.description}</p>
                </div>

                {/* Installation tabs */}
                {step.tabs && (
                  <div class="bg-slate-900 rounded-xl border border-slate-800 overflow-hidden" data-step-tabs>
                    <div class="flex flex-wrap border-b border-slate-800">
                      {step.tabs.map((tab, tabIndex) => (
                        <button
                          class:list={[
                            "px-3 py-2 sm:px-4 sm:py-3 text-xs sm:text-sm font-medium transition-colors whitespace-nowrap flex items-center gap-1.5 sm:gap-2",
                            tabIndex === 0 ? "bg-slate-800 text-white" : "text-slate-400 hover:text-white hover:bg-slate-800/50"
                          ]}
                          data-tab={tab.id}
                        >
                          <span class="emoji">{tab.icon}</span>
                          {tab.label}
                        </button>
                      ))}
                    </div>
                    {step.tabs.map((tab, tabIndex) => (
                      <div
                        class:list={["p-6", tabIndex !== 0 && "hidden"]}
                        data-tab-content={tab.id}
                      >
                        <div class="relative">
                          <button
                            class="absolute top-0 right-0 p-1.5 text-slate-500 hover:text-slate-300 transition-colors rounded hover:bg-slate-800/50 copy-tab-btn"
                            data-tab-id={tab.id}
                            title={copyTitle}
                          >
                            <svg class="w-4 h-4 copy-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                            </svg>
                            <svg class="w-4 h-4 check-icon hidden text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                            </svg>
                          </button>
                          <div class="font-mono text-sm space-y-1 pr-10">
                            {tab.commands.map(cmd => (
                              <div class={cmd.startsWith('#') ? 'text-slate-500' : ''}>
                                {!cmd.startsWith('#') && <span class="text-green-400">$ </span>}
                                <span class="text-white">{cmd}</span>
                              </div>
                            ))}
                          </div>
                        </div>
                        {tab.note && (
                          <p class="mt-4 text-sm text-slate-500">{tab.note}</p>
                        )}
                      </div>
                    ))}
                  </div>
                )}

                {/* HTML content */}
                {step.content && (
                  <div set:html={step.content} />
                )}

                {/* Code examples */}
                {step.code && (
                  <div class="bg-slate-900 rounded-xl border border-slate-800 p-6 font-mono text-sm space-y-4 relative">
                    <button
                      class="absolute top-4 right-4 p-1.5 text-slate-500 hover:text-slate-300 transition-colors rounded hover:bg-slate-800/50 copy-code-btn"
                      title={copyTitle}
                    >
                      <svg class="w-4 h-4 copy-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                      </svg>
                      <svg class="w-4 h-4 check-icon hidden text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                      </svg>
                    </button>
                    {step.code.map(line => (
                      <div>
                        <div class="text-green-400">{line.prompt} <span class="text-white">{line.cmd}</span></div>
                        {line.note && <div class="text-slate-500 text-xs mt-1"># {line.note}</div>}
                        <div class="text-slate-400 mt-1 whitespace-pre-wrap">{line.output}</div>
                      </div>
                    ))}
                  </div>
                )}

                {/* Terminal GIF recordings */}
                {step.number === '03' && (
                  <div class="mt-6">
                    <TerminalGif
                      src="/terminal/raps-auth.gif"
                      title={t('quickstart.terminal.auth_title')}
                      alt={t('quickstart.terminal.auth_alt')}
                    />
                  </div>
                )}
                {step.number === '04' && (
                  <div class="mt-6">
                    <TerminalGif
                      src="/terminal/raps-buckets.gif"
                      title={t('quickstart.terminal.bucket_title')}
                      alt={t('quickstart.terminal.bucket_alt')}
                    />
                  </div>
                )}
              </div>
            </div>
          </div>
        ))}
      </div>

      <!-- Success message -->
      <div class="mt-16 p-8 bg-gradient-to-r from-green-500/10 to-emerald-500/10 border border-green-500/20 rounded-xl text-center">
        <div class="text-4xl mb-4">üéâ</div>
        <h3 class="text-xl font-display font-bold text-white mb-2">{t('quickstart.success.title')}</h3>
        <p class="text-slate-400 mb-6">
          {t('quickstart.success.description')}
        </p>
        <a
          href="https://github.com/dmytro-yemelianov/raps"
          target="_blank"
          rel="noopener noreferrer"
          class="inline-flex items-center gap-2 px-6 py-2.5 bg-white/10 hover:bg-white/20 text-white rounded-lg transition-colors"
        >
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
            <path fill-rule="evenodd" clip-rule="evenodd" d="M12 2C6.477 2 2 6.477 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33.85 0 1.71.11 2.5.33 1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0012 2z" />
          </svg>
          {t('quickstart.success.star_github')}
        </a>
      </div>

      <!-- Next steps -->
      <div class="mt-16">
        <h3 class="text-xl font-display font-bold text-white mb-6">{t('quickstart.next_steps.title')}</h3>
        <div class="grid sm:grid-cols-2 gap-4">
          {nextSteps.map(item => (
            <a
              href={item.href}
              class="flex items-center gap-4 p-4 bg-slate-900/50 border border-slate-800 rounded-xl hover:border-primary-500/50 hover:bg-slate-900 transition-all group"
            >
              <span class="text-2xl emoji">{item.icon}</span>
              <span class="text-white font-medium group-hover:text-primary-400 transition-colors">{item.label}</span>
              <svg class="w-4 h-4 text-slate-500 group-hover:text-primary-400 ml-auto transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </a>
          ))}
        </div>
      </div>
    </div>
  </section>
</BaseLayout>

<script>
  // Helper function to strip prompt characters
  function stripPrompts(text) {
    return text.split('\n').map(line => {
      return line
        .replace(/^\s*\$+\s+/, '')           // $ or $$
        .replace(/^\s*#+\s+/, '')             // # (root prompt)
        .replace(/^\s*>\s+/, '')              // > (continuation)
        .replace(/^\s*PS\s*>\s*/, '')        // PS>
        .replace(/^\s*PS\s+[A-Z]:\\.*?>\s*/, '') // PS C:\...>
        .replace(/^\s*[A-Z]:\\.*?>\s*/, '')   // C:\...>
        .replace(/^\s*>>>\s+/, '')            // Python >>>
        .replace(/^\s*\.\.\.\s+/, '')         // ... continuation
        .replace(/^\s*\+\s+/, '');            // + continuation
    }).join('\n');
  }

  // Tab switching functionality
  document.querySelectorAll('[data-step-tabs]').forEach(tabContainer => {
    const buttons = tabContainer.querySelectorAll('[data-tab]');
    const contents = tabContainer.querySelectorAll('[data-tab-content]');

    buttons.forEach(button => {
      button.addEventListener('click', () => {
        const tabId = button.getAttribute('data-tab');

        // Update button styles
        buttons.forEach(btn => {
          btn.classList.remove('bg-slate-800', 'text-white');
          btn.classList.add('text-slate-400');
        });
        button.classList.add('bg-slate-800', 'text-white');
        button.classList.remove('text-slate-400');

        // Show/hide content
        contents.forEach(content => {
          if (content.getAttribute('data-tab-content') === tabId) {
            content.classList.remove('hidden');
          } else {
            content.classList.add('hidden');
          }
        });
      });
    });
  });

  // Copy buttons for tab commands
  document.querySelectorAll('.copy-tab-btn').forEach(btn => {
    btn.addEventListener('click', async function() {
      const tabId = this.getAttribute('data-tab-id');
      const tabContent = document.querySelector(`[data-tab-content="${tabId}"]`);
      if (!tabContent) return;

      // Extract all command text, skipping comments
      const commands = Array.from(tabContent.querySelectorAll('.font-mono > div'))
        .map(div => {
          const text = div.textContent || '';
          // Skip comment lines
          if (text.trim().startsWith('#')) return '';
          return text;
        })
        .filter(cmd => cmd.trim())
        .join('\n');

      const cleaned = stripPrompts(commands);
      await navigator.clipboard.writeText(cleaned);

      const copyIcon = this.querySelector('.copy-icon');
      const checkIcon = this.querySelector('.check-icon');

      copyIcon?.classList.add('hidden');
      checkIcon?.classList.remove('hidden');

      setTimeout(() => {
        copyIcon?.classList.remove('hidden');
        checkIcon?.classList.add('hidden');
      }, 2000);
    });
  });

  // Copy buttons for code examples
  document.querySelectorAll('.copy-code-btn').forEach(btn => {
    btn.addEventListener('click', async function() {
      const codeBlock = this.closest('.bg-slate-900');
      if (!codeBlock) return;

      // Extract all command lines (lines with prompts)
      const commands = Array.from(codeBlock.querySelectorAll('.text-green-400'))
        .map(el => {
          const parent = el.parentElement;
          if (!parent) return '';
          // Get the command part (everything after the prompt)
          const cmdSpan = parent.querySelector('.text-white');
          return cmdSpan ? cmdSpan.textContent || '' : '';
        })
        .filter(cmd => cmd.trim())
        .join('\n');

      const cleaned = stripPrompts(commands);
      await navigator.clipboard.writeText(cleaned);

      const copyIcon = this.querySelector('.copy-icon');
      const checkIcon = this.querySelector('.check-icon');

      copyIcon?.classList.add('hidden');
      checkIcon?.classList.remove('hidden');

      setTimeout(() => {
        copyIcon?.classList.remove('hidden');
        checkIcon?.classList.add('hidden');
      }, 2000);
    });
  });

  // Copy buttons for HTML content code blocks
  document.querySelectorAll('.copy-content-btn').forEach(btn => {
    btn.addEventListener('click', async function() {
      const target = this.getAttribute('data-copy-target');
      const container = this.closest('.relative');
      if (!container) return;

      const codeBlock = container.querySelector('.bg-slate-900');
      if (!codeBlock) return;

      // Extract text content, skipping comments
      const lines = Array.from(codeBlock.querySelectorAll('div'))
        .map(div => {
          const text = div.textContent || '';
          // For PowerShell, extract the actual command part
          if (text.includes('$env:')) {
            return text.replace(/.*?\$env:/, '$env:').trim();
          }
          return text.trim();
        })
        .filter(line => {
          const trimmed = line.trim();
          return trimmed && !trimmed.startsWith('#');
        });

      const commands = lines.join('\n');
      const cleaned = stripPrompts(commands);
      await navigator.clipboard.writeText(cleaned);

      const copyIcon = this.querySelector('.copy-icon');
      const checkIcon = this.querySelector('.check-icon');

      copyIcon?.classList.add('hidden');
      checkIcon?.classList.remove('hidden');

      setTimeout(() => {
        copyIcon?.classList.remove('hidden');
        checkIcon?.classList.add('hidden');
      }, 2000);
    });
  });
</script>
