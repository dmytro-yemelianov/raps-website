---
import CookbookLayout from '../../layouts/CookbookLayout.astro';
import { getCollection, render, type CollectionEntry } from 'astro:content';
import { stripLocalePrefix, getLangFromUrl, getLocalizedUrl, filterByLocale, localizeEntry } from '../../i18n/utils';

const getDocSlug = (doc: any) => {
  const raw = doc.slug || doc.id || '';
  return stripLocalePrefix(raw.replace(/\.mdx?$/, ''));
};

export async function getStaticPaths() {
  const cookbook = (await getCollection('cookbook')).filter(d => d.id.startsWith('en/'));
  return cookbook.map(doc => {
    const slug = stripLocalePrefix((doc.slug || doc.id || '').replace(/\.mdx?$/, ''));
    return {
      params: { slug },
      props: { doc, slug },
    };
  });
}

interface Props {
  doc: CollectionEntry<'cookbook'>;
  slug: string;
}

const { doc: enDoc, slug } = Astro.props;
const lang = getLangFromUrl(Astro.url, Astro.currentLocale);
const allCookbookRaw = await getCollection('cookbook');
const doc = localizeEntry(enDoc, allCookbookRaw, lang);
const { Content } = await render(doc);

// Get localized cookbook for prev/next navigation
const allCookbook = filterByLocale(allCookbookRaw, lang);

// Find prev/next in same category
const categoryDocs = allCookbook
  .filter(d => d.data.category === doc.data.category)
  .sort((a, b) => a.data.order - b.data.order);
const sectionIndex = categoryDocs.findIndex(d => getDocSlug(d) === slug);
const prevDoc = sectionIndex > 0 ? categoryDocs[sectionIndex - 1] : null;
const nextDoc = sectionIndex < categoryDocs.length - 1 ? categoryDocs[sectionIndex + 1] : null;
---

<CookbookLayout
  title={doc.data.title}
  description={doc.data.description}
  currentSlug={slug}
>
  <div class="max-w-4xl mx-auto px-6 py-12">
    <article class="docs-content">
      <Content />
    </article>

    <!-- Navigation -->
    <nav class="mt-16 pt-8 border-t border-slate-800">
      <div class="flex justify-between gap-4">
        {prevDoc ? (
          <a
            href={getLocalizedUrl(lang, `/cookbook/${getDocSlug(prevDoc)}`)}
            class="flex-1 group p-4 bg-slate-900/50 border border-slate-800 rounded-lg hover:border-slate-700 transition-colors"
          >
            <div class="text-sm text-slate-500 mb-1">&larr; Previous</div>
            <div class="font-medium text-white group-hover:text-rapeseed-400 transition-colors">
              {prevDoc.data.icon && <span class="mr-2">{prevDoc.data.icon}</span>}
              {prevDoc.data.title}
            </div>
          </a>
        ) : <div class="flex-1"></div>}

        {nextDoc ? (
          <a
            href={getLocalizedUrl(lang, `/cookbook/${getDocSlug(nextDoc)}`)}
            class="flex-1 group p-4 bg-slate-900/50 border border-slate-800 rounded-lg hover:border-slate-700 transition-colors text-right"
          >
            <div class="text-sm text-slate-500 mb-1">Next &rarr;</div>
            <div class="font-medium text-white group-hover:text-rapeseed-400 transition-colors">
              {nextDoc.data.title}
              {nextDoc.data.icon && <span class="ml-2">{nextDoc.data.icon}</span>}
            </div>
          </a>
        ) : <div class="flex-1"></div>}
      </div>
    </nav>
  </div>
</CookbookLayout>
