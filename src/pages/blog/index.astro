---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

// Get all blog posts, sorted by date
const allPosts = (await getCollection('blog'))
  .filter(post => !post.data.draft)
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

// Get featured posts
const featuredPosts = allPosts.filter(post => post.data.featured);
const regularPosts = allPosts.filter(post => !post.data.featured);

// Extract all unique tags for filtering
const allTags = [...new Set(allPosts.flatMap(post => post.data.tags || []))].sort();

// Group posts by category/tag for analytics
const tagGroups = allTags.map(tag => ({
  name: tag,
  count: allPosts.filter(post => post.data.tags?.includes(tag)).length,
  posts: allPosts.filter(post => post.data.tags?.includes(tag))
}));

const formatDate = (date: Date) => {
  return new Intl.DateTimeFormat('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  }).format(date);
};

// Calculate reading time estimate
const getReadingTime = (content: string) => {
  const wordsPerMinute = 200;
  const words = content.split(/\s+/).length;
  const minutes = Math.ceil(words / wordsPerMinute);
  return minutes;
};
---

<BaseLayout 
  title="Blog" 
  description="Articles about CI/CD for Autodesk Platform Services, APS automation, and RAPS CLI tutorials."
>
  <section class="py-16 sm:py-24">
    <div class="max-w-7xl mx-auto px-4 sm:px-6">
      <!-- Header -->
      <div class="mb-16 text-center">
        <h1 class="text-4xl sm:text-6xl font-display font-black text-white mb-6">
          DevOps for <span class="text-transparent bg-clip-text bg-gradient-to-r from-rapeseed-400 to-amber-400">Design</span>
        </h1>
        <p class="text-xl text-slate-300 max-w-3xl mx-auto mb-8">
          Bringing CI/CD to AEC technology. Real-world tutorials, automation guides, and hard-earned insights from the trenches of APS development.
        </p>
        
        <!-- Blog Stats -->
        <div class="flex items-center justify-center gap-8 text-sm text-slate-400">
          <div class="flex items-center gap-2">
            <svg class="w-4 h-4 text-rapeseed-400" fill="currentColor" viewBox="0 0 20 20">
              <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <span>{allPosts.length} Articles</span>
          </div>
          <div class="flex items-center gap-2">
            <svg class="w-4 h-4 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
              <path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM2 11a2 2 0 012-2h12a2 2 0 012 2v4a2 2 0 01-2 2H4a2 2 0 01-2-2v-4z"/>
            </svg>
            <span>{allTags.length} Topics</span>
          </div>
          <div class="flex items-center gap-2">
            <svg class="w-4 h-4 text-green-400" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>
            </svg>
            <span>Weekly Updates</span>
          </div>
        </div>
      </div>

      <!-- Category Filter - Collapsible -->
      <div class="mb-12">
        <button 
          id="toggle-topics"
          class="flex items-center gap-2 text-lg font-semibold text-white mb-4 hover:text-rapeseed-400 transition-colors"
        >
          <span>Browse by Topic</span>
          <svg class="w-4 h-4 transition-transform" id="topics-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
          </svg>
        </button>
        <div class="hidden" id="category-filters-wrapper">
          <div class="flex flex-wrap gap-3" id="category-filters">
            <button 
              class="category-filter active px-4 py-2 bg-rapeseed-500 text-slate-900 rounded-full text-sm font-medium transition-all hover:bg-rapeseed-400" 
              data-category="all"
            >
              All Posts ({allPosts.length})
            </button>
            {tagGroups.map(tag => (
              <button 
                class="category-filter px-4 py-2 bg-slate-800 hover:bg-slate-700 text-slate-300 hover:text-white rounded-full text-sm font-medium transition-all" 
                data-category={tag.name}
              >
                {tag.name} ({tag.count})
              </button>
            ))}
          </div>
        </div>
      </div>
      
      {allPosts.length === 0 ? (
        <div class="text-center py-16 bg-slate-900/50 rounded-xl border border-slate-800">
          <div class="text-6xl mb-4">üìù</div>
          <h3 class="text-xl font-semibold text-white mb-2">Coming Soon</h3>
          <p class="text-slate-400 mb-6">We're working on amazing content about APS development and DevOps for design teams.</p>
          <div class="flex items-center justify-center gap-4">
            <a
              href="https://github.com/dmytro-yemelianov/raps"
              target="_blank"
              class="px-6 py-3 bg-rapeseed-500 hover:bg-rapeseed-400 text-slate-900 font-semibold rounded-lg transition-colors"
            >
              Follow on GitHub
            </a>
            <a
              href="https://discord.gg/PXRabMhWTY"
              target="_blank"
              class="px-6 py-3 border border-slate-700 hover:border-slate-600 text-slate-300 hover:text-white rounded-lg transition-colors"
            >
              Join Discord
            </a>
          </div>
        </div>
      ) : (
        <div>
          <!-- Featured Posts -->
          {featuredPosts.length > 0 && (
            <div class="mb-16">
              <div class="flex items-center gap-3 mb-8">
                <svg class="w-6 h-6 text-rapeseed-400" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                </svg>
                <h2 class="text-2xl font-bold text-white">Featured Articles</h2>
              </div>
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                {featuredPosts.map((post) => (
                  <article class="group featured-post" data-tags={JSON.stringify(post.data.tags || [])}>
                    <a href={`/blog/${post.slug}`} class="block">
                      <div class="p-8 bg-gradient-to-br from-slate-900/80 to-slate-800/80 border border-rapeseed-500/20 rounded-2xl hover:border-rapeseed-400/40 transition-all hover:shadow-lg hover:shadow-rapeseed-500/10">
                        <div class="flex items-center gap-2 mb-4">
                          <span class="px-2 py-1 bg-rapeseed-500/20 text-rapeseed-400 text-xs font-medium rounded-full">
                            Featured
                          </span>
                          <time class="text-sm text-slate-500" datetime={post.data.pubDate.toISOString()}>
                            {formatDate(post.data.pubDate)}
                          </time>
                        </div>
                        <h3 class="text-xl font-bold text-white mb-3 group-hover:text-rapeseed-400 transition-colors">
                          {post.data.title}
                        </h3>
                        <p class="text-slate-300 mb-4 line-clamp-3">
                          {post.data.description}
                        </p>
                        <div class="flex items-center justify-between">
                          <div class="flex flex-wrap gap-2">
                            {post.data.tags?.slice(0, 3).map((tag: string) => (
                              <span class="px-2 py-1 text-xs font-medium bg-slate-800 text-slate-300 rounded">
                                {tag}
                              </span>
                            ))}
                          </div>
                          <span class="text-sm text-rapeseed-400 group-hover:text-rapeseed-300">
                            Read article ‚Üí
                          </span>
                        </div>
                      </div>
                    </a>
                  </article>
                ))}
              </div>
            </div>
          )}

          <!-- Regular Posts -->
          <div class="mb-8">
            <h2 class="text-xl font-semibold text-white mb-6">All Articles</h2>
            <div class="space-y-6" id="posts-container">
              {regularPosts.map((post) => (
                <article class="group blog-post" data-tags={JSON.stringify(post.data.tags || [])}>
                  <a href={`/blog/${post.slug}`} class="block">
                    <div class="p-6 bg-slate-900/50 border border-slate-800 rounded-xl hover:border-rapeseed-400/30 transition-all hover:bg-slate-900/80">
                      <div class="flex flex-wrap items-center gap-3 mb-3">
                        <time class="text-sm text-slate-500" datetime={post.data.pubDate.toISOString()}>
                          {formatDate(post.data.pubDate)}
                        </time>
                        <span class="text-slate-600">‚Ä¢</span>
                        <span class="text-sm text-slate-500">5 min read</span>
                        {post.data.tags?.map((tag: string) => (
                          <span class="px-2 py-1 text-xs font-medium bg-slate-800 text-slate-300 rounded">
                            {tag}
                          </span>
                        ))}
                      </div>
                      <h3 class="text-xl font-semibold text-white mb-2 group-hover:text-rapeseed-400 transition-colors">
                        {post.data.title}
                      </h3>
                      <p class="text-slate-400 line-clamp-2 mb-4">
                        {post.data.description}
                      </p>
                      <div class="flex items-center justify-between">
                        <span class="text-sm text-slate-500">By {post.data.author || 'RAPS Team'}</span>
                        <span class="text-sm text-rapeseed-400 group-hover:text-rapeseed-300">
                          Read more ‚Üí
                        </span>
                      </div>
                    </div>
                  </a>
                </article>
              ))}
            </div>
          </div>
        </div>
      )}
      
      <!-- Newsletter CTA -->
      <div class="mt-16 bg-gradient-to-r from-rapeseed-500/10 to-amber-500/10 border border-rapeseed-500/20 rounded-2xl p-8">
        <div class="text-center">
          <div class="text-4xl mb-4">üì¨</div>
          <h3 class="text-2xl font-bold text-white mb-4">
            Never Miss a DevOps Insight
          </h3>
          <p class="text-slate-300 mb-6 max-w-2xl mx-auto">
            Get the latest tutorials, automation guides, and APS development insights delivered weekly. Stay ahead of the curve with expert-level content.
          </p>
          <div class="flex flex-col sm:flex-row items-center justify-center gap-4 mb-6">
            <div class="flex gap-2 w-full max-w-sm">
              <input
                type="email"
                placeholder="your@email.com"
                class="flex-1 px-4 py-3 bg-slate-900 border border-slate-700 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:border-rapeseed-400"
              />
              <button
                class="px-6 py-3 bg-rapeseed-500 hover:bg-rapeseed-400 text-slate-900 font-semibold rounded-lg transition-colors"
                onclick="window.analytics?.track('email_signup_attempt', {source: 'blog_footer'})"
              >
                Subscribe
              </button>
            </div>
          </div>
          <div class="flex flex-col sm:flex-row items-center justify-center gap-6 text-sm text-slate-500">
            <div class="flex items-center gap-4">
              <a
                href="/rss.xml"
                class="flex items-center gap-2 px-3 py-2 bg-slate-800 hover:bg-slate-700 text-slate-300 hover:text-white rounded-lg transition-colors"
              >
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M6.18 15.64a2.18 2.18 0 0 1 2.18 2.18C8.36 19 7.38 20 6.18 20C5 20 4 19 4 17.82a2.18 2.18 0 0 1 2.18-2.18M4 4.44A15.56 15.56 0 0 1 19.56 20h-2.83A12.73 12.73 0 0 0 4 7.27V4.44m0 5.66a9.9 9.9 0 0 1 9.9 9.9h-2.83A7.07 7.07 0 0 0 4 12.93V10.1Z"/>
                </svg>
                RSS Feed
              </a>
              <a
                href="https://github.com/dmytro-yemelianov/raps"
                target="_blank"
                rel="noopener noreferrer"
                class="flex items-center gap-2 px-3 py-2 text-slate-400 hover:text-white transition-colors"
              >
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                  <path fill-rule="evenodd" clip-rule="evenodd" d="M12 2C6.477 2 2 6.477 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33.85 0 1.71.11 2.5.33 1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0012 2z" />
                </svg>
                Star on GitHub
              </a>
            </div>
            <span>No spam ‚Ä¢ Unsubscribe anytime</span>
          </div>
        </div>
      </div>
    </div>
  </section>
</BaseLayout>

<script>
  // Blog category filtering functionality
  document.addEventListener('DOMContentLoaded', function() {
    // Toggle topics section
    const toggleBtn = document.getElementById('toggle-topics');
    const filtersWrapper = document.getElementById('category-filters-wrapper');
    const chevron = document.getElementById('topics-chevron');
    
    toggleBtn?.addEventListener('click', function() {
      const isHidden = filtersWrapper?.classList.contains('hidden');
      
      if (isHidden) {
        filtersWrapper?.classList.remove('hidden');
        chevron?.classList.add('rotate-180');
      } else {
        filtersWrapper?.classList.add('hidden');
        chevron?.classList.remove('rotate-180');
      }
    });
    
    const filterButtons = document.querySelectorAll('.category-filter');
    const blogPosts = document.querySelectorAll('.blog-post');
    const featuredPosts = document.querySelectorAll('.featured-post');
    
    filterButtons.forEach(button => {
      button.addEventListener('click', function() {
        const category = this.getAttribute('data-category');
        
        // Update active state
        filterButtons.forEach(btn => {
          btn.classList.remove('active', 'bg-rapeseed-500', 'text-slate-900');
          btn.classList.add('bg-slate-800', 'text-slate-300');
        });
        
        this.classList.add('active', 'bg-rapeseed-500', 'text-slate-900');
        this.classList.remove('bg-slate-800', 'text-slate-300');
        
        // Filter posts
        const allPosts = [...blogPosts, ...featuredPosts];
        
        allPosts.forEach(post => {
          const postTags = JSON.parse(post.getAttribute('data-tags') || '[]');
          const shouldShow = category === 'all' || postTags.includes(category);
          
          if (shouldShow) {
            post.style.display = 'block';
            post.style.opacity = '0';
            setTimeout(() => {
              post.style.opacity = '1';
            }, 50);
          } else {
            post.style.opacity = '0';
            setTimeout(() => {
              post.style.display = 'none';
            }, 200);
          }
        });
        
        // Track category filter usage
        if (window.analytics) {
          window.analytics.track('blog_category_filter', {
            category: category,
            posts_shown: allPosts.filter(post => {
              const postTags = JSON.parse(post.getAttribute('data-tags') || '[]');
              return category === 'all' || postTags.includes(category);
            }).length
          });
        }
      });
    });
    
    // Track blog engagement
    const blogLinks = document.querySelectorAll('a[href^="/blog/"]');
    blogLinks.forEach(link => {
      link.addEventListener('click', function() {
        const postTitle = this.querySelector('h3')?.textContent || 'Unknown';
        const postTags = JSON.parse(this.closest('[data-tags]')?.getAttribute('data-tags') || '[]');
        
        if (window.analytics) {
          window.analytics.track('blog_post_click', {
            title: postTitle,
            tags: postTags,
            featured: this.closest('.featured-post') !== null
          });
        }
      });
    });
  });
</script>
