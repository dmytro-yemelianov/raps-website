---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

// Get all blog posts, sorted by date
const allPosts = (await getCollection('blog'))
  .filter(post => !post.data.draft)
  .sort((a, b) => new Date(b.data.pubDate).valueOf() - new Date(a.data.pubDate).valueOf());

// Get featured posts
const featuredPosts = allPosts.filter(post => post.data.featured);
const regularPosts = allPosts.filter(post => !post.data.featured);

// Extract all unique tags for filtering
const allTags = [...new Set(allPosts.flatMap(post => post.data.tags || []))].sort();

// Group posts by category/tag for analytics
const tagGroups = allTags.map(tag => ({
  name: tag,
  count: allPosts.filter(post => post.data.tags?.includes(tag)).length,
  posts: allPosts.filter(post => post.data.tags?.includes(tag))
}));

const formatDate = (date: Date) => {
  return new Intl.DateTimeFormat('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  }).format(date);
};

// Calculate reading time estimate
const getReadingTime = (content: string) => {
  const wordsPerMinute = 200;
  const words = content.split(/\s+/).length;
  const minutes = Math.ceil(words / wordsPerMinute);
  return minutes;
};
---

<BaseLayout 
  title="Blog" 
  description="Articles about CI/CD for Autodesk Platform Services, APS automation, and RAPS CLI tutorials."
>
  <section class="py-16 sm:py-24">
    <div class="max-w-7xl mx-auto px-4 sm:px-6">
      <!-- Header -->
      <div class="mb-16 text-center">
        <h1 class="text-4xl sm:text-6xl font-display font-black text-white mb-6">
          DevOps for <span class="text-transparent bg-clip-text bg-gradient-to-r from-rapeseed-400 to-amber-400">Design</span>
        </h1>
        <p class="text-xl text-slate-300 max-w-3xl mx-auto mb-8">
          Bringing CI/CD to AEC technology. Real-world tutorials, automation guides, and hard-earned insights from the trenches of APS development.
        </p>
        
        <!-- Blog Stats -->
        <div class="flex items-center justify-center gap-8 text-sm text-slate-400">
          <div class="flex items-center gap-2">
            <svg class="w-4 h-4 text-rapeseed-400" fill="currentColor" viewBox="0 0 20 20">
              <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <span>{allPosts.length} Articles</span>
          </div>
          <div class="flex items-center gap-2">
            <svg class="w-4 h-4 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
              <path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM2 11a2 2 0 012-2h12a2 2 0 012 2v4a2 2 0 01-2 2H4a2 2 0 01-2-2v-4z"/>
            </svg>
            <span>{allTags.length} Topics</span>
          </div>
          <div class="flex items-center gap-2">
            <svg class="w-4 h-4 text-green-400" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>
            </svg>
            <span>Weekly Updates</span>
          </div>
        </div>
      </div>

      <!-- Category Filter - Collapsible -->
      <div class="mb-12">
        <button 
          id="toggle-topics"
          class="flex items-center gap-2 text-lg font-semibold text-white mb-4 hover:text-rapeseed-400 transition-colors"
        >
          <span>Browse by Topic</span>
          <svg class="w-4 h-4 transition-transform" id="topics-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
          </svg>
        </button>
        <div class="hidden" id="category-filters-wrapper">
          <div class="flex flex-wrap gap-3" id="category-filters">
            <button 
              class="category-filter active px-4 py-2 bg-rapeseed-500 text-slate-900 rounded-full text-sm font-medium transition-all hover:bg-rapeseed-400" 
              data-category="all"
            >
              All Posts ({allPosts.length})
            </button>
            {tagGroups.map(tag => (
              <button 
                class="category-filter px-4 py-2 bg-slate-800 hover:bg-slate-700 text-slate-300 hover:text-white rounded-full text-sm font-medium transition-all" 
                data-category={tag.name}
              >
                {tag.name} ({tag.count})
              </button>
            ))}
          </div>
        </div>
      </div>
      
      {allPosts.length === 0 ? (
        <div class="text-center py-16 bg-slate-900/50 rounded-xl border border-slate-800">
          <div class="text-6xl mb-4">üìù</div>
          <h3 class="text-xl font-semibold text-white mb-2">Coming Soon</h3>
          <p class="text-slate-400 mb-6">We're working on amazing content about APS development and DevOps for design teams.</p>
          <div class="flex items-center justify-center gap-4">
            <a
              href="https://github.com/dmytro-yemelianov/raps"
              target="_blank"
              class="px-6 py-3 bg-rapeseed-500 hover:bg-rapeseed-400 text-slate-900 font-semibold rounded-lg transition-colors"
            >
              Follow on GitHub
            </a>
            <a
              href="https://discord.gg/PXRabMhWTY"
              target="_blank"
              class="px-6 py-3 border border-slate-700 hover:border-slate-600 text-slate-300 hover:text-white rounded-lg transition-colors"
            >
              Join Discord
            </a>
          </div>
        </div>
      ) : (
        <div class="flex flex-col gap-4" id="blog-posts-list">
          {allPosts.map((post, index) => (
            <article class="group blog-post" data-tags={JSON.stringify(post.data.tags || [])} style="transition: opacity 0.2s ease;">
              <a href={`/blog/${post.id.replace(/\.mdx?$/, '')}`} class="block">
                <div class="p-6 bg-slate-900/50 border border-slate-800 rounded-xl hover:border-primary-500/50 transition-all hover:bg-slate-900">
                  <div class="flex flex-wrap items-center gap-3 mb-3">
                    <time class="text-sm text-slate-500" datetime={new Date(post.data.pubDate).toISOString()}>
                      {formatDate(new Date(post.data.pubDate))}
                    </time>
                    {post.data.tags?.map((tag: string) => (
                      <span class="px-2 py-0.5 text-xs font-medium bg-primary-500/10 text-primary-400 rounded">
                        {tag}
                      </span>
                    ))}
                  </div>
                  <h2 class="text-xl font-semibold text-white mb-2 group-hover:text-primary-400 transition-colors">
                    {post.data.title}
                  </h2>
                  <p class="text-slate-400 text-sm line-clamp-2">
                    {post.data.description}
                  </p>
                  <div class="mt-4 text-sm text-primary-400 group-hover:text-primary-300">
                    Read article &rarr;
                  </div>
                </div>
              </a>
            </article>
          ))}
        </div>
        )
        )}
      </div>
      
      <!-- Newsletter CTA -->
      <div class="mt-16 bg-gradient-to-r from-rapeseed-500/10 to-amber-500/10 border border-rapeseed-500/20 rounded-2xl p-8">
        <div class="text-center">
          <div class="text-4xl mb-4">üì¨</div>
          <h3 class="text-2xl font-bold text-white mb-4">
            Never Miss a DevOps Insight
          </h3>
          <p class="text-slate-300 mb-6 max-w-2xl mx-auto">
            Get the latest tutorials, automation guides, and APS development insights delivered weekly. Stay ahead of the curve with expert-level content.
          </p>
          <form id="newsletter-form" class="flex flex-col sm:flex-row items-center justify-center gap-4 mb-6" novalidate>
            <div class="flex gap-2 w-full max-w-sm">
              <input
                id="newsletter-email"
                type="email"
                name="email"
                required
                placeholder="your@email.com"
                class="flex-1 px-4 py-3 bg-slate-900 border border-slate-700 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:border-rapeseed-400 text-base"
                autocomplete="email"
              />
              <button
                type="submit"
                class="px-6 py-3 bg-rapeseed-500 hover:bg-rapeseed-400 text-slate-900 font-semibold rounded-lg transition-colors whitespace-nowrap"
              >
                Subscribe
              </button>
            </div>
            <p id="newsletter-feedback" class="text-sm hidden w-full text-center"></p>
          </form>
          <div class="flex flex-col sm:flex-row items-center justify-center gap-6 text-sm text-slate-500">
            <div class="flex items-center gap-4">
              <a
                href="/rss.xml"
                class="flex items-center gap-2 px-3 py-2 bg-slate-800 hover:bg-slate-700 text-slate-300 hover:text-white rounded-lg transition-colors"
              >
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M6.18 15.64a2.18 2.18 0 0 1 2.18 2.18C8.36 19 7.38 20 6.18 20C5 20 4 19 4 17.82a2.18 2.18 0 0 1 2.18-2.18M4 4.44A15.56 15.56 0 0 1 19.56 20h-2.83A12.73 12.73 0 0 0 4 7.27V4.44m0 5.66a9.9 9.9 0 0 1 9.9 9.9h-2.83A7.07 7.07 0 0 0 4 12.93V10.1Z"/>
                </svg>
                RSS Feed
              </a>
              <a
                href="https://github.com/dmytro-yemelianov/raps"
                target="_blank"
                rel="noopener noreferrer"
                class="flex items-center gap-2 px-3 py-2 text-slate-400 hover:text-white transition-colors"
              >
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                  <path fill-rule="evenodd" clip-rule="evenodd" d="M12 2C6.477 2 2 6.477 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33.85 0 1.71.11 2.5.33 1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0012 2z" />
                </svg>
                Star on GitHub
              </a>
            </div>
            <span>No spam ‚Ä¢ Unsubscribe anytime</span>
          </div>
        </div>
      </div>
    </div>
  </section>
</BaseLayout>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Toggle topics section
    const toggleBtn = document.getElementById('toggle-topics');
    const filtersWrapper = document.getElementById('category-filters-wrapper');
    const chevron = document.getElementById('topics-chevron');

    toggleBtn?.addEventListener('click', function() {
      const isHidden = filtersWrapper?.classList.contains('hidden');
      if (isHidden) {
        filtersWrapper?.classList.remove('hidden');
        chevron?.classList.add('rotate-180');
      } else {
        filtersWrapper?.classList.add('hidden');
        chevron?.classList.remove('rotate-180');
      }
    });

    // Blog category filtering
    const filterButtons = document.querySelectorAll('.category-filter');
    const blogPosts = document.querySelectorAll('.blog-post');

    filterButtons.forEach(button => {
      button.addEventListener('click', function() {
        const category = this.getAttribute('data-category');

        // Update active state
        filterButtons.forEach(btn => {
          btn.classList.remove('active', 'bg-rapeseed-500', 'text-slate-900');
          btn.classList.add('bg-slate-800', 'text-slate-300');
        });
        this.classList.add('active', 'bg-rapeseed-500', 'text-slate-900');
        this.classList.remove('bg-slate-800', 'text-slate-300');

        // Filter posts
        blogPosts.forEach(post => {
          const postTags = JSON.parse(post.getAttribute('data-tags') || '[]');
          const shouldShow = category === 'all' || postTags.includes(category);

          if (shouldShow) {
            post.style.display = 'block';
            requestAnimationFrame(() => { post.style.opacity = '1'; });
          } else {
            post.style.opacity = '0';
            setTimeout(() => { post.style.display = 'none'; }, 200);
          }
        });
      });
    });

    // Newsletter form handling
    const form = document.getElementById('newsletter-form');
    const emailInput = document.getElementById('newsletter-email') as HTMLInputElement;
    const feedback = document.getElementById('newsletter-feedback');

    form?.addEventListener('submit', function(e) {
      e.preventDefault();
      const email = emailInput?.value?.trim();

      if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        if (feedback) {
          feedback.textContent = 'Please enter a valid email address.';
          feedback.className = 'text-sm w-full text-center text-red-400';
        }
        return;
      }

      // Show success state (replace with real endpoint when available)
      if (feedback) {
        feedback.textContent = 'Thanks for subscribing! We\'ll be in touch.';
        feedback.className = 'text-sm w-full text-center text-emerald-400';
      }
      if (emailInput) emailInput.value = '';

      // Track signup
      if ((window as any).analytics) {
        (window as any).analytics.track('email_signup', { source: 'blog_footer', email });
      }
    });
  });
</script>
