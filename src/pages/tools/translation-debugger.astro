---
import BaseLayout from '../../layouts/BaseLayout.astro';
---

<BaseLayout 
  title="APS Translation Failure Diagnosis Tool" 
  description="Debug APS Model Derivative translation failures with human-readable explanations and solutions. Get help with TranslationWorker-InternalFailure and other common issues."
>
  <div class="tool-container">
    <h1 class="tool-title">üîç APS Translation Failure Diagnosis Tool</h1>
    <p class="tool-subtitle">Get human-readable explanations for cryptic Model Derivative error messages</p>
    
    <div class="raps-tip">
      <h3>üí° RAPS CLI Alternative</h3>
      <p>Skip manual debugging with RAPS CLI:</p>
      <p><code>raps translate status &lt;urn&gt; --diagnose</code></p>
      <p><code>raps translate retry &lt;urn&gt; --fix-common-issues</code></p>
    </div>
    
    <!-- Input Section -->
    <div class="input-section">
      <h3>üîç Analyze Translation Job</h3>
      
      <div class="input-group">
        <label for="urnInput">URN (Base64 encoded):</label>
        <input type="text" id="urnInput" placeholder="dXJuOmFkc2sub2JqZWN0czpvcy5vYmplY3Q6..." onchange="fetchManifest()">
        <small>Enter the URN of your failed translation job</small>
      </div>
      
      <div class="input-group">
        <label for="manifestInput">Or paste manifest JSON directly:</label>
        <textarea id="manifestInput" rows="8" placeholder="Paste the manifest JSON from GET /modelderivative/v2/designdata/{urn}/manifest"></textarea>
      </div>
      
      <button class="analyze-btn" onclick="analyzeTranslation()">üîç Diagnose Translation Failure</button>
    </div>
    
    <!-- Results Section -->
    <div id="resultsSection" class="results-section" style="display: none;">
      <h3 id="resultsTitle">üìã Diagnosis Results</h3>
      <div id="diagnosisContent"></div>
    </div>
    
    <!-- Common Patterns Reference -->
    <div class="common-patterns">
      <h3>üìö Common Failure Patterns Reference</h3>
      <table class="pattern-table">
        <thead>
          <tr>
            <th>Manifest Status</th>
            <th>Messages Content</th>
            <th>Likely Cause</th>
            <th>Solution</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><span class="status-indicator status-failed">failed</span></td>
            <td>"Tr worker fail to download"</td>
            <td>File deleted or moved</td>
            <td>Re-upload file to OSS</td>
          </tr>
          <tr>
            <td><span class="status-indicator status-failed">failed</span></td>
            <td>"TranslationWorker-InternalFailure"</td>
            <td>Corrupted or unsupported file</td>
            <td>Check file integrity, verify format support</td>
          </tr>
          <tr>
            <td><span class="status-indicator status-success">success</span></td>
            <td>No viewable derivatives</td>
            <td>Wrong output format requested</td>
            <td>Specify SVF2 as output format</td>
          </tr>
          <tr>
            <td><span class="status-indicator status-inprogress">inprogress</span></td>
            <td>Stuck for hours</td>
            <td>Large file timeout or queue issue</td>
            <td>Wait 24h or split large files</td>
          </tr>
          <tr>
            <td><span class="status-indicator status-failed">failed</span></td>
            <td>Region mismatch errors</td>
            <td>File in EMEA, processing in US</td>
            <td>Delete manifest, re-translate in correct region</td>
          </tr>
          <tr>
            <td><span class="status-indicator status-timeout">timeout</span></td>
            <td>Processing timeout</td>
            <td>File too complex or large</td>
            <td>Simplify model, reduce file size, split assemblies</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</BaseLayout>

<style>
  .tool-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0;
  }
  
  .tool-title {
    @apply text-3xl sm:text-4xl font-display font-bold text-white mb-4 text-center;
  }
  
  .tool-subtitle {
    @apply text-center text-slate-300 mb-8 text-lg;
  }
  
  .raps-tip {
    @apply bg-blue-950/30 border border-blue-800/30 rounded-lg p-6 mb-8;
  }
  
  .raps-tip h3 {
    @apply text-lg font-semibold text-blue-300 mb-3 mt-0;
  }
  
  .raps-tip code {
    @apply bg-blue-900/50 text-blue-200 px-2 py-1 rounded text-sm font-mono;
  }
  
  .input-section {
    @apply bg-slate-800/30 rounded-lg p-6 mb-8 border-l-4 border-cyan-500;
  }
  
  .input-section h3 {
    @apply text-xl font-semibold text-white mb-4 mt-0;
  }
  
  .input-group {
    @apply mb-6;
  }
  
  .input-group label {
    @apply block mb-2 font-semibold text-slate-200;
  }
  
  .input-group input,
  .input-group textarea {
    @apply w-full p-3 border-2 border-slate-600 rounded-lg bg-slate-900 text-slate-300 font-mono text-sm transition-colors;
  }
  
  .input-group input:focus,
  .input-group textarea:focus {
    @apply outline-none border-cyan-400;
  }
  
  .input-group textarea {
    @apply min-h-[200px] resize-y;
  }
  
  .input-group small {
    @apply text-slate-400 text-sm mt-1 block;
  }
  
  .analyze-btn {
    @apply bg-cyan-600 hover:bg-cyan-500 text-white px-6 py-3 rounded-lg text-lg font-semibold cursor-pointer transition-colors;
  }
  
  .analyze-btn:hover {
    @apply transform translate-y-px shadow-lg;
  }
  
  .analyze-btn:disabled {
    @apply bg-slate-600 cursor-not-allowed;
  }
  
  .results-section {
    @apply bg-green-950/20 border-2 border-green-600 rounded-lg p-6 mb-8;
  }
  
  .results-section.error {
    @apply bg-red-950/20 border-red-600;
  }
  
  .results-section.warning {
    @apply bg-yellow-950/20 border-yellow-600;
  }
  
  .results-section h3 {
    @apply text-xl font-semibold text-green-300 mb-4 mt-0;
  }
  
  .results-section.error h3 {
    @apply text-red-300;
  }
  
  .results-section.warning h3 {
    @apply text-yellow-300;
  }
  
  .diagnosis-item {
    @apply bg-slate-900/50 rounded-lg p-5 mb-4 border-l-4 border-green-500;
  }
  
  .diagnosis-item.error {
    @apply border-red-500;
  }
  
  .diagnosis-item.warning {
    @apply border-yellow-500;
  }
  
  .diagnosis-title {
    @apply text-xl font-bold mb-3 text-white;
  }
  
  .diagnosis-cause {
    @apply text-red-400 font-semibold mb-2;
  }
  
  .diagnosis-fix {
    @apply text-green-400 font-semibold mb-2;
  }
  
  .manifest-display {
    @apply bg-slate-800/50 border border-slate-600 rounded p-4 font-mono text-sm text-slate-300 mb-4 break-all;
  }
  
  .status-indicator {
    @apply inline-block px-2 py-1 rounded-full text-xs font-bold uppercase;
  }
  
  .status-failed {
    @apply bg-red-600 text-white;
  }
  
  .status-success {
    @apply bg-green-600 text-white;
  }
  
  .status-inprogress {
    @apply bg-yellow-600 text-slate-900;
  }
  
  .status-timeout {
    @apply bg-purple-600 text-white;
  }
  
  .common-patterns {
    @apply bg-slate-800/30 rounded-lg p-6 mb-8;
  }
  
  .common-patterns h3 {
    @apply text-xl font-semibold text-white mb-4 mt-0;
  }
  
  .pattern-table {
    @apply w-full border-collapse bg-slate-900/50 rounded-lg overflow-hidden border border-slate-700;
  }
  
  .pattern-table th,
  .pattern-table td {
    @apply px-4 py-3 text-left border-b border-slate-700;
  }
  
  .pattern-table th {
    @apply bg-slate-700 text-white font-semibold;
  }
  
  .pattern-table tr:nth-child(even) {
    @apply bg-slate-800/30;
  }
  
  .loading {
    @apply text-center py-5;
  }
  
  .spinner {
    @apply border-2 border-slate-600 border-t-cyan-500 rounded-full w-8 h-8 animate-spin mx-auto mb-3;
  }
  
  .info-box {
    @apply bg-blue-950/20 border border-blue-600 rounded-lg p-4 mb-4;
  }
  
  .info-box h4 {
    @apply text-lg font-semibold text-blue-300 mb-2 mt-0;
  }
  
  @media (max-width: 768px) {
    .tool-title {
      @apply text-2xl;
    }
  }
</style>

<script>
  let currentManifest = null;
  
  function fetchManifest() {
    const urn = document.getElementById('urnInput').value.trim();
    if (!urn) return;
    
    // In a real implementation, this would call the APS API
    // For demo purposes, we'll simulate different manifest scenarios
    simulateManifestFetch(urn);
  }
  
  function simulateManifestFetch(urn) {
    const btn = document.querySelector('.analyze-btn');
    btn.disabled = true;
    btn.innerHTML = '<div class="spinner"></div> Fetching manifest...';
    
    // Simulate API delay
    setTimeout(() => {
      // Generate sample manifest based on URN pattern for demo
      const sampleManifests = {
        'failed': {
          "status": "failed",
          "progress": "complete",
          "messages": [
            {
              "type": "error", 
              "message": "TranslationWorker-InternalFailure",
              "code": "TranslationWorker-InternalFailure"
            }
          ],
          "derivatives": []
        },
        'success_no_viewable': {
          "status": "success",
          "progress": "complete", 
          "messages": [],
          "derivatives": [
            {
              "name": "model.pdf",
              "hasThumbnail": false,
              "status": "success",
              "outputType": "pdf"
            }
          ]
        },
        'stuck': {
          "status": "inprogress",
          "progress": "25%",
          "messages": [],
          "derivatives": []
        },
        'download_fail': {
          "status": "failed",
          "progress": "complete",
          "messages": [
            {
              "type": "error",
              "message": "Tr worker fail to download input file from https://developer.api.autodesk.com/oss/v2/buckets/...",
              "code": "TranslationWorker-FailedDownload"
            }
          ],
          "derivatives": []
        }
      };
      
      // Choose manifest type based on URN content for demo
      let manifestType = 'failed';
      if (urn.includes('success')) manifestType = 'success_no_viewable';
      if (urn.includes('stuck')) manifestType = 'stuck';
      if (urn.includes('download')) manifestType = 'download_fail';
      
      currentManifest = sampleManifests[manifestType];
      document.getElementById('manifestInput').value = JSON.stringify(currentManifest, null, 2);
      
      btn.disabled = false;
      btn.innerHTML = 'üîç Diagnose Translation Failure';
      
      // Auto-analyze
      analyzeTranslation();
    }, 1500);
  }
  
  function analyzeTranslation() {
    let manifest;
    
    // Try to get manifest from textarea first
    const manifestText = document.getElementById('manifestInput').value.trim();
    if (manifestText) {
      try {
        manifest = JSON.parse(manifestText);
      } catch (e) {
        showResults('Error', 'Invalid JSON in manifest. Please check the format.', 'error');
        return;
      }
    } else if (currentManifest) {
      manifest = currentManifest;
    } else {
      showResults('Error', 'Please provide a URN or manifest JSON to analyze.', 'error');
      return;
    }
    
    // Analyze the manifest
    const diagnosis = diagnoseManifest(manifest);
    showResults('Diagnosis Complete', generateDiagnosisHTML(diagnosis), diagnosis.severity);
  }
  
  function diagnoseManifest(manifest) {
    const diagnosis = {
      status: manifest.status,
      issues: [],
      recommendations: [],
      severity: 'success'
    };
    
    // Check overall status
    if (manifest.status === 'failed') {
      diagnosis.severity = 'error';
      diagnosis.issues.push({
        title: 'Translation Failed',
        cause: 'The translation job completed with failure status',
        type: 'error'
      });
    } else if (manifest.status === 'inprogress') {
      diagnosis.severity = 'warning';
      diagnosis.issues.push({
        title: 'Translation In Progress',
        cause: 'Job is still processing or may be stuck',
        type: 'warning'
      });
    }
    
    // Analyze error messages
    if (manifest.messages && manifest.messages.length > 0) {
      manifest.messages.forEach(msg => {
        if (msg.type === 'error') {
          const errorAnalysis = analyzeErrorMessage(msg.message);
          diagnosis.issues.push({
            title: errorAnalysis.title,
            cause: errorAnalysis.cause,
            fix: errorAnalysis.fix,
            type: 'error',
            originalMessage: msg.message
          });
          if (diagnosis.severity !== 'error') diagnosis.severity = 'error';
        }
      });
    }
    
    // Check for missing viewable derivatives
    const hasViewable = manifest.derivatives && manifest.derivatives.some(d => 
      d.outputType === 'svf' || d.outputType === 'svf2'
    );
    
    if (manifest.status === 'success' && !hasViewable) {
      diagnosis.issues.push({
        title: 'No Viewable Derivatives',
        cause: 'Translation succeeded but no SVF/SVF2 derivatives were generated',
        fix: 'Request SVF2 format explicitly in your translation job',
        type: 'warning'
      });
      if (diagnosis.severity === 'success') diagnosis.severity = 'warning';
    }
    
    // Generate recommendations
    diagnosis.recommendations = generateRecommendations(diagnosis);
    
    return diagnosis;
  }
  
  function analyzeErrorMessage(message) {
    if (message.includes('fail to download')) {
      return {
        title: 'Source File Download Failed',
        cause: 'The translation service could not download your source file from OSS',
        fix: 'Verify the file still exists in OSS bucket. Re-upload if necessary.'
      };
    }
    
    if (message.includes('TranslationWorker-InternalFailure')) {
      return {
        title: 'Internal Translation Failure',
        cause: 'File corruption, unsupported format, or service issue',
        fix: 'Check file integrity, verify format is supported, try re-uploading with a different file'
      };
    }
    
    if (message.includes('timeout') || message.includes('Processing timeout')) {
      return {
        title: 'Processing Timeout',
        cause: 'File too large or complex for standard processing',
        fix: 'Reduce file size, simplify geometry, or split into multiple files'
      };
    }
    
    if (message.includes('region') || message.includes('EMEA')) {
      return {
        title: 'Region Mismatch',
        cause: 'File uploaded to different region than processing endpoint',
        fix: 'Delete manifest and re-translate using the correct regional endpoint'
      };
    }
    
    if (message.includes('format') || message.includes('unsupported')) {
      return {
        title: 'Unsupported Format',
        cause: 'File format not supported by Model Derivative service',
        fix: 'Convert to supported format (DWG, RVT, IPT, STEP, etc.) before upload'
      };
    }
    
    // Generic fallback
    return {
      title: 'Translation Error',
      cause: 'Generic translation failure',
      fix: 'Check APS documentation for specific error details'
    };
  }
  
  function generateRecommendations(diagnosis) {
    const recs = [];
    
    if (diagnosis.severity === 'error') {
      recs.push('Use RAPS CLI for automatic retry with common fixes: `raps translate retry <urn> --fix-common-issues`');
      recs.push('Check the APS Service Status page for any ongoing issues');
    }
    
    if (diagnosis.status === 'inprogress') {
      recs.push('Large files can take several hours. Wait up to 24 hours before considering it stuck.');
      recs.push('Use `raps translate status <urn> --watch` to monitor progress');
    }
    
    recs.push('Enable verbose logging in your next translation job to get more detailed error information');
    recs.push('Consider using RAPS CLI which handles most common failure scenarios automatically');
    
    return recs;
  }
  
  function generateDiagnosisHTML(diagnosis) {
    let html = `
      <div class="manifest-display">
        <strong>Status:</strong> <span class="status-indicator status-${diagnosis.status.toLowerCase()}">${diagnosis.status}</span>
      </div>
    `;
    
    if (diagnosis.issues.length > 0) {
      html += '<h4 class="text-lg font-semibold text-white mb-3 mt-6">üö® Issues Found:</h4>';
      diagnosis.issues.forEach(issue => {
        html += `
          <div class="diagnosis-item ${issue.type}">
            <div class="diagnosis-title">${issue.title}</div>
            <div class="diagnosis-cause">‚ùå Cause: ${issue.cause}</div>
            ${issue.fix ? `<div class="diagnosis-fix">‚úÖ Fix: ${issue.fix}</div>` : ''}
            ${issue.originalMessage ? `<div class="mt-3 text-sm"><strong class="text-slate-300">Original message:</strong> "${issue.originalMessage}"</div>` : ''}
          </div>
        `;
      });
    }
    
    if (diagnosis.recommendations.length > 0) {
      html += '<h4 class="text-lg font-semibold text-white mb-3 mt-6">üí° Recommendations:</h4><ul class="list-disc list-inside space-y-1 text-slate-300">';
      diagnosis.recommendations.forEach(rec => {
        html += `<li>${rec}</li>`;
      });
      html += '</ul>';
    }
    
    html += `
      <div class="raps-tip mt-6">
        <h3>üöÄ Quick Fix with RAPS CLI</h3>
        <p>Let RAPS handle the complexity:</p>
        <p><code>raps translate retry &lt;urn&gt; --auto-fix</code></p>
        <p><code>raps translate status &lt;urn&gt; --verbose</code></p>
      </div>
    `;
    
    return html;
  }
  
  function showResults(title, content, type = 'success') {
    const resultsSection = document.getElementById('resultsSection');
    const resultsTitle = document.getElementById('resultsTitle');
    const diagnosisContent = document.getElementById('diagnosisContent');
    
    resultsSection.className = `results-section ${type}`;
    resultsTitle.textContent = title;
    diagnosisContent.innerHTML = content;
    resultsSection.style.display = 'block';
    
    // Scroll to results
    resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
  
  // Sample data for demonstration
  document.addEventListener('DOMContentLoaded', function() {
    // Add some sample URNs for testing
    const urnInput = document.getElementById('urnInput');
    urnInput.placeholder = 'Try: failed_sample, success_sample, stuck_sample, download_sample';
  });
</script>
</BaseLayout>