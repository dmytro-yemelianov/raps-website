---
import BaseLayout from '../../layouts/BaseLayout.astro';
---

<BaseLayout 
  title="APS URN Encoder/Decoder Tool" 
  description="Interactive tool to encode and decode Autodesk Platform Services (APS) URNs with base64 URL-safe encoding for API calls and file identification."
>
  <div class="tool-container">
    <h1 class="tool-title">üõ†Ô∏è APS URN Encoder/Decoder</h1>
    <p class="tool-subtitle">Interactive tool for Autodesk Platform Services URN encoding and decoding</p>
    
    <div class="raps-tip">
      <h3>üí° RAPS CLI Alternative</h3>
      <p>Instead of using this web tool, you can use RAPS CLI:</p>
      <p><code>raps urn encode "urn:adsk.objects:os.object:bucket/file.dwg"</code></p>
      <p><code>raps urn decode "dXJuOmFkc2sub2JqZWN0cy..."</code></p>
    </div>
    
    <!-- URN Encoder Section -->
    <div class="tool-section">
      <h2>Encode URN to Base64</h2>
      <p>Convert a plain URN to base64 URL-safe encoded format for APS API calls</p>
      
      <label for="urnInput">Enter URN:</label>
      <input type="text" id="urnInput" placeholder="urn:adsk.objects:os.object:mybucket/model.rvt" />
      
      <button onclick="encodeURN()">üîí Encode URN</button>
      <button onclick="validateURN()">‚úÖ Validate Format</button>
      
      <div id="encodeResult"></div>
      <div id="urnValidation"></div>
    </div>
    
    <!-- URN Decoder Section -->
    <div class="tool-section">
      <h2>Decode Base64 to URN</h2>
      <p>Convert a base64 encoded URN back to readable format</p>
      
      <label for="base64Input">Enter Base64 Encoded URN:</label>
      <textarea id="base64Input" placeholder="dXJuOmFkc2sub2JqZWN0cy5vcy5vYmplY3Q6bXlidWNrZXQvbW9kZWwucnZ0"></textarea>
      
      <button onclick="decodeURN()">üîì Decode URN</button>
      <button onclick="validateBase64()">‚úÖ Validate Base64</button>
      
      <div id="decodeResult"></div>
      <div id="base64Validation"></div>
    </div>
    
    <!-- Examples Section -->
    <div class="examples">
      <h3>üìã Common URN Examples</h3>
      <p>Click any example to use it in the encoder:</p>
      
      <div class="example-item" onclick="setExample('oss')">
        <div class="example-label">Object Storage Service (OSS)</div>
        <div class="example-value">urn:adsk.objects:os.object:mybucket/model.rvt</div>
      </div>
      
      <div class="example-item" onclick="setExample('dm')">
        <div class="example-label">Data Management (BIM 360/ACC)</div>
        <div class="example-value">urn:adsk.wipprod:dm.lineage:12345678-1234-5678-9abc-123456789012</div>
      </div>
      
      <div class="example-item" onclick="setExample('revit')">
        <div class="example-label">OSS with Revit File</div>
        <div class="example-value">urn:adsk.objects:os.object:construction-models/building-A.rvt</div>
      </div>
      
      <div class="example-item" onclick="setExample('dwg')">
        <div class="example-label">OSS with AutoCAD File</div>
        <div class="example-value">urn:adsk.objects:os.object:cad-drawings/floor-plan.dwg</div>
      </div>
      
      <div class="example-item" onclick="setExample('inventor')">
        <div class="example-label">OSS with Inventor Assembly</div>
        <div class="example-value">urn:adsk.objects:os.object:mechanical-parts/assembly.iam</div>
      </div>
    </div>
    
    <!-- Format Information -->
    <div class="format-info">
      <h4>üìñ URN Format Guide</h4>
      <p><strong>Object Storage Service URN:</strong></p>
      <p><code>urn:adsk.objects:os.object:{bucket}/{object}</code></p>
      
      <p><strong>Data Management URN:</strong></p>
      <p><code>urn:adsk.wipprod:dm.lineage:{item-id}</code></p>
      
      <p><strong>Base64 Encoding Rules:</strong></p>
      <ul>
        <li>Standard base64 encoding</li>
        <li>Replace <code>+</code> with <code>-</code></li>
        <li>Replace <code>/</code> with <code>_</code></li>
        <li>Remove padding <code>=</code> characters</li>
      </ul>
    </div>
    
    <!-- Advanced Tools -->
    <div class="tool-section">
      <h2>Advanced Tools</h2>
      
      <button onclick="generateRandomURN()">üé≤ Generate Test URN</button>
      <button onclick="batchProcess()">üì¶ Batch Process</button>
      <button onclick="copyToClipboard('lastEncoded')">üìã Copy Last Result</button>
      <button onclick="clearAll()">üóëÔ∏è Clear All</button>
      
      <div id="advancedResult"></div>
    </div>
  </div>
</BaseLayout>

<style>
  .tool-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 0;
  }
  
  .tool-title {
    @apply text-3xl sm:text-4xl font-display font-bold text-white mb-4 text-center;
  }
  
  .tool-subtitle {
    @apply text-center text-slate-300 mb-8 text-lg;
  }
  
  .raps-tip {
    @apply bg-blue-950/30 border border-blue-800/30 rounded-lg p-6 mb-8;
  }
  
  .raps-tip h3 {
    @apply text-lg font-semibold text-blue-300 mb-3 mt-0;
  }
  
  .raps-tip code {
    @apply bg-blue-900/50 text-blue-200 px-2 py-1 rounded text-sm font-mono;
  }
  
  .tool-section {
    @apply bg-slate-800/30 rounded-lg p-6 mb-8 border-l-4 border-yellow-500;
  }
  
  .tool-section h2 {
    @apply text-xl font-semibold text-white mb-4 mt-0 flex items-center gap-2;
  }
  
  .tool-section h2::before {
    @apply text-2xl;
    content: "üîß";
  }
  
  label {
    @apply block mb-2 font-semibold text-slate-200;
  }
  
  input[type="text"], textarea {
    @apply w-full p-3 border-2 border-slate-600 rounded-lg bg-slate-900 text-slate-300 font-mono text-sm transition-colors;
  }
  
  input[type="text"]:focus, textarea:focus {
    @apply outline-none border-yellow-400;
  }
  
  textarea {
    @apply resize-vertical min-h-[100px];
  }
  
  button {
    @apply bg-yellow-600 hover:bg-yellow-500 text-slate-900 px-4 py-2 rounded-lg font-semibold mr-2 mb-2 cursor-pointer transition-all;
  }
  
  button:hover {
    @apply transform translate-y-px shadow-lg;
  }
  
  .result {
    @apply bg-green-950/20 border border-green-600 rounded-lg p-4 mt-4 break-all font-mono;
  }
  
  .error {
    @apply bg-red-950/20 border border-red-600 text-red-200;
  }
  
  .examples {
    @apply bg-yellow-950/20 border border-yellow-600 rounded-lg p-6 mb-8;
  }
  
  .examples h3 {
    @apply text-xl font-semibold text-yellow-300 mb-4 mt-0;
  }
  
  .example-item {
    @apply mb-3 p-3 bg-slate-900/50 rounded cursor-pointer transition-colors hover:bg-slate-800/50;
  }
  
  .example-label {
    @apply font-semibold text-slate-200 mb-1;
  }
  
  .example-value {
    @apply font-mono text-sm text-slate-400 break-all;
  }
  
  .format-info {
    @apply bg-slate-800/30 border border-slate-600 rounded-lg p-6 mb-8;
  }
  
  .format-info h4 {
    @apply text-lg font-semibold text-white mb-3 mt-0;
  }
  
  .format-info code {
    @apply bg-slate-900 text-yellow-400 px-2 py-1 rounded text-sm;
  }
  
  .format-info ul {
    @apply list-disc list-inside space-y-1 text-slate-300 mt-2;
  }
  
  .validation {
    @apply mt-3 p-3 border rounded;
  }
  
  .validation.valid {
    @apply bg-green-950/20 border-green-600 text-green-200;
  }
  
  .validation.invalid {
    @apply bg-red-950/20 border-red-600 text-red-200;
  }
  
  .copy-btn {
    @apply bg-slate-600 hover:bg-slate-500 text-white text-xs px-3 py-1 ml-2;
  }
  
  @media (max-width: 768px) {
    .tool-title {
      @apply text-2xl;
    }
    
    .tool-section {
      @apply p-4;
    }
  }
</style>

<script>
  let lastEncoded = '';
  let lastDecoded = '';

  // URN Encoding Function
  function encodeURN() {
    const urn = document.getElementById('urnInput').value.trim();
    const resultDiv = document.getElementById('encodeResult');
    
    if (!urn) {
      showResult(resultDiv, 'Please enter a URN to encode.', 'error');
      return;
    }
    
    try {
      // Convert to base64 and make URL-safe
      const encoded = btoa(urn)
        .replace(/\+/g, '-')
        .replace(/\//g, '_')
        .replace(/=/g, '');
      
      lastEncoded = encoded;
      
      const html = `
        <div class="result">
          <strong>Encoded URN:</strong><br>
          <span class="break-all">${encoded}</span>
          <button class="copy-btn" onclick="copyToClipboard('${encoded}')">Copy</button>
        </div>
        <div class="format-info mt-3">
          <h4>üîß Usage in API calls:</h4>
          <p><strong>Model Derivative:</strong><br>
          <code>GET /modelderivative/v2/designdata/${encoded}/manifest</code></p>
          
          <p><strong>With RAPS:</strong><br>
          <code>raps translate ${encoded} --formats svf2</code></p>
        </div>
      `;
      showResult(resultDiv, html);
      
    } catch (error) {
      showResult(resultDiv, `Encoding failed: ${error.message}`, 'error');
    }
  }

  // URN Decoding Function
  function decodeURN() {
    const base64 = document.getElementById('base64Input').value.trim();
    const resultDiv = document.getElementById('decodeResult');
    
    if (!base64) {
      showResult(resultDiv, 'Please enter a base64 encoded URN to decode.', 'error');
      return;
    }
    
    try {
      // Convert URL-safe base64 back to standard base64
      let standardBase64 = base64
        .replace(/-/g, '+')
        .replace(/_/g, '/');
      
      // Add padding if needed
      while (standardBase64.length % 4) {
        standardBase64 += '=';
      }
      
      const decoded = atob(standardBase64);
      lastDecoded = decoded;
      
      const html = `
        <div class="result">
          <strong>Decoded URN:</strong><br>
          <span class="break-all">${decoded}</span>
          <button class="copy-btn" onclick="copyToClipboard('${decoded}')">Copy</button>
        </div>
        ${analyzeURN(decoded)}
      `;
      showResult(resultDiv, html);
      
    } catch (error) {
      showResult(resultDiv, `Decoding failed: ${error.message}`, 'error');
    }
  }

  // URN Analysis Function
  function analyzeURN(urn) {
    let analysis = '<div class="format-info mt-3"><h4>üîç URN Analysis:</h4>';
    
    if (urn.includes('urn:adsk.objects:os.object:')) {
      const parts = urn.split(':');
      const objectPath = parts[4] || '';
      const pathParts = objectPath.split('/');
      const bucket = pathParts[0] || 'Unknown';
      const object = pathParts.slice(1).join('/') || 'Unknown';
      
      analysis += `
        <p><strong>Type:</strong> Object Storage Service (OSS)</p>
        <p><strong>Bucket:</strong> ${bucket}</p>
        <p><strong>Object:</strong> ${object}</p>
        <p><strong>File Extension:</strong> ${object.split('.').pop()?.toUpperCase() || 'Unknown'}</p>
      `;
    } else if (urn.includes('urn:adsk.wipprod:dm.lineage:')) {
      const itemId = urn.split(':')[3] || 'Unknown';
      analysis += `
        <p><strong>Type:</strong> Data Management (BIM 360/ACC)</p>
        <p><strong>Item ID:</strong> ${itemId}</p>
      `;
    } else {
      analysis += '<p><strong>Type:</strong> Unknown or custom URN format</p>';
    }
    
    analysis += '</div>';
    return analysis;
  }

  // Validation Functions
  function validateURN() {
    const urn = document.getElementById('urnInput').value.trim();
    const validationDiv = document.getElementById('urnValidation');
    
    if (!urn) {
      showValidation(validationDiv, 'Please enter a URN to validate.', false);
      return;
    }
    
    const isValid = urn.startsWith('urn:adsk.') && urn.includes(':');
    const message = isValid ? 
      '‚úÖ Valid URN format' : 
      '‚ùå Invalid URN format. Should start with "urn:adsk." and contain colons.';
      
    showValidation(validationDiv, message, isValid);
  }

  function validateBase64() {
    const base64 = document.getElementById('base64Input').value.trim();
    const validationDiv = document.getElementById('base64Validation');
    
    if (!base64) {
      showValidation(validationDiv, 'Please enter base64 text to validate.', false);
      return;
    }
    
    try {
      // Test if it's valid base64
      const standardBase64 = base64.replace(/-/g, '+').replace(/_/g, '/');
      atob(standardBase64.padEnd(standardBase64.length + (4 - standardBase64.length % 4) % 4, '='));
      showValidation(validationDiv, '‚úÖ Valid base64 format', true);
    } catch (error) {
      showValidation(validationDiv, '‚ùå Invalid base64 format', false);
    }
  }

  // Utility Functions
  function showResult(element, content, type = '') {
    element.innerHTML = `<div class="result ${type}">${content}</div>`;
  }

  function showValidation(element, message, isValid) {
    const className = isValid ? 'valid' : 'invalid';
    element.innerHTML = `<div class="validation ${className}">${message}</div>`;
  }

  function setExample(type) {
    const examples = {
      'oss': 'urn:adsk.objects:os.object:mybucket/model.rvt',
      'dm': 'urn:adsk.wipprod:dm.lineage:12345678-1234-5678-9abc-123456789012',
      'revit': 'urn:adsk.objects:os.object:construction-models/building-A.rvt',
      'dwg': 'urn:adsk.objects:os.object:cad-drawings/floor-plan.dwg',
      'inventor': 'urn:adsk.objects:os.object:mechanical-parts/assembly.iam'
    };
    
    document.getElementById('urnInput').value = examples[type] || '';
  }

  function generateRandomURN() {
    const bucketName = 'test-bucket-' + Math.random().toString(36).substr(2, 9);
    const fileName = 'model-' + Math.random().toString(36).substr(2, 5) + '.rvt';
    const urn = `urn:adsk.objects:os.object:${bucketName}/${fileName}`;
    
    document.getElementById('urnInput').value = urn;
    document.getElementById('advancedResult').innerHTML = 
      '<div class="result">üé≤ Random test URN generated! Click "Encode URN" to process it.</div>';
  }

  function batchProcess() {
    const urnInput = document.getElementById('urnInput').value.trim();
    const base64Input = document.getElementById('base64Input').value.trim();
    
    if (!urnInput && !base64Input) {
      document.getElementById('advancedResult').innerHTML = 
        '<div class="result error">Enter URN or Base64 text to process.</div>';
      return;
    }
    
    let results = '<div class="result"><h4>üì¶ Batch Processing Results:</h4>';
    
    if (urnInput) {
      try {
        const encoded = btoa(urnInput).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
        results += `<p><strong>Encoded:</strong> ${encoded}</p>`;
      } catch (error) {
        results += `<p><strong>Encoding Error:</strong> ${error.message}</p>`;
      }
    }
    
    if (base64Input) {
      try {
        const standardBase64 = base64Input.replace(/-/g, '+').replace(/_/g, '/');
        const padded = standardBase64.padEnd(standardBase64.length + (4 - standardBase64.length % 4) % 4, '=');
        const decoded = atob(padded);
        results += `<p><strong>Decoded:</strong> ${decoded}</p>`;
      } catch (error) {
        results += `<p><strong>Decoding Error:</strong> ${error.message}</p>`;
      }
    }
    
    results += '</div>';
    document.getElementById('advancedResult').innerHTML = results;
  }

  function copyToClipboard(text) {
    if (text === 'lastEncoded') {
      text = lastEncoded;
    } else if (text === 'lastDecoded') {
      text = lastDecoded;
    }
    
    if (!text) {
      alert('Nothing to copy. Process a URN first.');
      return;
    }
    
    navigator.clipboard.writeText(text).then(() => {
      // Create temporary feedback
      const originalText = event.target.textContent;
      event.target.textContent = 'Copied!';
      event.target.style.background = '#22c55e';
      
      setTimeout(() => {
        event.target.textContent = originalText;
        event.target.style.background = '#64748b';
      }, 1000);
    }).catch(err => {
      // Fallback for older browsers
      const textarea = document.createElement('textarea');
      textarea.value = text;
      document.body.appendChild(textarea);
      textarea.select();
      document.execCommand('copy');
      document.body.removeChild(textarea);
      alert('Copied to clipboard!');
    });
  }

  function clearAll() {
    document.getElementById('urnInput').value = '';
    document.getElementById('base64Input').value = '';
    document.getElementById('encodeResult').innerHTML = '';
    document.getElementById('decodeResult').innerHTML = '';
    document.getElementById('urnValidation').innerHTML = '';
    document.getElementById('base64Validation').innerHTML = '';
    document.getElementById('advancedResult').innerHTML = '';
    lastEncoded = '';
    lastDecoded = '';
  }

  // Event Listeners
  document.addEventListener('DOMContentLoaded', () => {
    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      if (e.ctrlKey && e.key === 'Enter') {
        if (document.activeElement.id === 'urnInput') {
          encodeURN();
        } else if (document.activeElement.id === 'base64Input') {
          decodeURN();
        }
      }
    });

    // Auto-process when pasting
    document.getElementById('urnInput').addEventListener('paste', function(e) {
      setTimeout(() => {
        if (e.target.value.trim()) {
          validateURN();
        }
      }, 100);
    });

    document.getElementById('base64Input').addEventListener('paste', function(e) {
      setTimeout(() => {
        if (e.target.value.trim()) {
          validateBase64();
        }
      }, 100);
    });
  });
</script>
</BaseLayout>