---
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import GlobalSearch from '../components/GlobalSearch.astro';
import '../styles/globals.css';
import '../styles/accessibility.css';

interface Props {
  title: string;
  description?: string;
  image?: string;
  article?: boolean;
}

const { 
  title, 
  description = 'ðŸŒ¼ RAPS (rapeseed) â€” Rust Autodesk Platform Services CLI. A comprehensive command-line interface for APS, written in Rust.',
  image = '/og-image.svg',
  article = false,
} = Astro.props;

const canonicalURL = new URL(Astro.url.pathname, Astro.site);
---

<!doctype html>
<html lang="en" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="canonical" href={canonicalURL} />
    
    <!-- Primary Meta Tags -->
    <title>{title} | RAPS</title>
    <meta name="title" content={`${title} | RAPS`} />
    <meta name="description" content={description} />
    <meta name="author" content="Dmytro Yemelianov" />
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content={article ? 'article' : 'website'} />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:title" content={`${title} | RAPS`} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={new URL(image, Astro.site)} />
    <meta property="og:site_name" content="RAPS CLI" />
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content={canonicalURL} />
    <meta property="twitter:title" content={`${title} | RAPS`} />
    <meta property="twitter:description" content={description} />
    <meta property="twitter:image" content={new URL(image, Astro.site)} />
    <meta property="twitter:site" content="@dyemelianov" />
    <meta property="twitter:creator" content="@dyemelianov" />
    
    <!-- Additional SEO -->
    <meta name="robots" content="index, follow" />
    <meta name="googlebot" content="index, follow" />
    <meta name="keywords" content="Autodesk Platform Services, APS, CLI, Rust, CAD, BIM, DevOps, CI/CD, Model Derivative, OAuth, automation" />
    
    <!-- Performance optimizations -->
    <link rel="dns-prefetch" href="//github.com">
    <link rel="dns-prefetch" href="//api.github.com">
    <meta name="theme-color" content="#0f172a">
    <meta name="color-scheme" content="dark">
    
    <!-- Optimized font loading - using system fonts for performance -->
    <style>
      /* Custom font definitions with system font fallbacks */
      :root {
        --font-display: ui-serif, Georgia, Cambria, "Times New Roman", Times, serif;
        --font-sans: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
        --font-mono: ui-monospace, SFMono-Regular, "SF Mono", Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      }
      
      .font-display { font-family: var(--font-display); }
      .font-sans { font-family: var(--font-sans); }
      .font-mono { font-family: var(--font-mono); }
    </style>
    
    <!-- JSON-LD structured data -->
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "SoftwareApplication",
        "name": "ðŸŒ¼ RAPS",
        "alternateName": "rapeseed",
        "applicationCategory": "DeveloperApplication",
        "operatingSystem": "Windows, macOS, Linux, Docker",
        "author": {
          "@type": "Person",
          "name": "Dmytro Yemelianov",
          "url": "https://www.linkedin.com/in/dmytro-yemelianov/",
          "image": "https://rapscli.xyz/images/profile-400.webp",
          "sameAs": [
            "https://github.com/dmytro-yemelianov",
            "https://twitter.com/dyemelianov",
            "https://www.linkedin.com/in/dmytro-yemelianov/"
          ]
        },
        "description": "ðŸŒ¼ RAPS (rapeseed) â€” Rust Autodesk Platform Services CLI. A comprehensive command-line interface for APS, written in Rust.",
        "license": "https://opensource.org/licenses/Apache-2.0",
        "url": "https://rapscli.xyz",
        "downloadUrl": "https://github.com/dmytro-yemelianov/raps/releases",
        "softwareVersion": "3.8.0",  // UPDATE: Sync with RAPS CLI releases
        "datePublished": "2024-01-01",
        "dateModified": "2026-01-10",
        "programmingLanguage": "Rust",
        "offers": {
          "@type": "Offer",
          "price": "0",
          "priceCurrency": "USD"
        },
        "aggregateRating": {
          "@type": "AggregateRating",
          "ratingValue": "5",
          "reviewCount": "12",
          "bestRating": "5",
          "worstRating": "1"
        },
        "featureList": [
          "OAuth 2.0 authentication",
          "Object Storage Service (OSS) operations",
          "Model Derivative API",
          "Data Management API",
          "Design Automation API",
          "CI/CD pipeline integration",
          "GitHub Actions support", 
          "Docker containerization",
          "Interactive shell mode",
          "Model Context Protocol (MCP) server"
        ],
        "screenshot": "https://rapscli.xyz/og-image.svg",
        "softwareRequirements": "Rust 1.88+",
        "keywords": "Autodesk Platform Services, APS, CLI, Rust, CAD, BIM, DevOps, CI/CD"
      }
    </script>

    <!-- Privacy-First Analytics - deferred for performance -->
    <script defer>
      // Simple privacy-first analytics
      window.analytics = {
        track: function(event, properties = {}) {
          // Only track in production
          if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            console.log('Analytics (dev):', event, properties);
            return;
          }
          
          // Respect user privacy preferences
          if (navigator.doNotTrack === '1' || navigator.globalPrivacyControl) {
            return;
          }
          
          try {
            // Simple beacon to collect anonymous usage data
            const data = {
              event: event,
              page: window.location.pathname,
              timestamp: Date.now(),
              referrer: document.referrer || 'direct',
              userAgent: navigator.userAgent,
              ...properties
            };
            
            // Send anonymized data (no cookies, no personal data)
            fetch('/api/analytics', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(data),
              keepalive: true
            }).catch(() => {}); // Silently fail
          } catch (e) {
            // Analytics should never break the site
          }
        }
      };

      // Track page views
      window.analytics.track('page_view', {
        title: document.title,
        url: window.location.href
      });
      
      // Track outbound links
      document.addEventListener('click', function(e) {
        const link = e.target.closest('a');
        if (link && link.href) {
          const url = new URL(link.href, window.location.origin);
          
          // Track external links
          if (url.hostname !== window.location.hostname) {
            window.analytics.track('external_link_click', {
              url: link.href,
              text: link.textContent?.trim() || '',
              destination: url.hostname
            });
          }
          
          // Track specific internal actions
          if (link.href.includes('/tools/')) {
            window.analytics.track('tool_access', {
              tool: link.href.split('/tools/')[1]?.split('/')[0] || 'unknown'
            });
          }
          
          if (link.href.includes('github.com')) {
            window.analytics.track('github_click', {
              action: link.textContent?.toLowerCase().includes('star') ? 'star' : 'visit'
            });
          }
          
          if (link.href.includes('discord')) {
            window.analytics.track('discord_click');
          }
          
          if (link.href.includes('/quickstart')) {
            window.analytics.track('quickstart_click');
          }
        }
      });
      
      // Track email signups
      document.addEventListener('submit', function(e) {
        const form = e.target;
        if (form && form.querySelector('input[type="email"]')) {
          window.analytics.track('email_signup_attempt');
        }
      });
      
      // Track copy button usage
      document.addEventListener('click', function(e) {
        if (e.target.closest('.copy-btn') || e.target.closest('[class*="copy"]')) {
          window.analytics.track('code_copy', {
            section: window.location.pathname
          });
        }
      });
    </script>
    
  </head>
  <body class="min-h-screen bg-slate-950 text-slate-100 font-sans antialiased">
    
    <Header />
    <GlobalSearch />
    <main id="main-content" tabindex="-1">
      <slot />
    </main>
    <Footer />
    
    <!-- Mermaid.js -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.9.3/dist/mermaid.min.js"></script>

    <!-- Global Code Block Enhancement -->
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        // Initialize Mermaid
        if (typeof mermaid !== 'undefined') {
          mermaid.initialize({
            startOnLoad: false,
            theme: 'dark',
            themeVariables: {
              primaryColor: '#1e293b',
              primaryBorderColor: '#f5c542',
              primaryTextColor: '#f1f5f9',
              secondaryColor: '#0f172a',
              lineColor: '#64748b',
              textColor: '#f1f5f9',
              mainBkg: '#1e293b',
              nodeBorder: '#f5c542',
            },
            flowchart: { curve: 'basis', padding: 20 },
          });

          // Find and render mermaid blocks
          document.querySelectorAll('pre[data-language="mermaid"]').forEach(async (pre, i) => {
            const code = pre.querySelector('code')?.textContent || pre.textContent || '';
            const container = document.createElement('div');
            container.className = 'mermaid-diagram';
            try {
              const { svg } = await mermaid.render(`mermaid-${i}`, code);
              container.innerHTML = svg;
              pre.parentNode.replaceChild(container, pre);
            } catch (e) {
              console.error('Mermaid error:', e);
            }
          });
        }

        // Enhance code blocks with header and copy button
        document.querySelectorAll('pre:not([data-language="mermaid"])').forEach((pre) => {
          if (pre.parentNode.classList.contains('code-block-wrapper')) return;

          const wrapper = document.createElement('div');
          wrapper.className = 'code-block-wrapper';
          pre.parentNode.insertBefore(wrapper, pre);
          wrapper.appendChild(pre);

          const lang = pre.getAttribute('data-language') || '';

          const header = document.createElement('div');
          header.className = 'code-block-header';
          header.innerHTML = `
            <span class="code-lang">${lang}</span>
            <button class="copy-btn" aria-label="Copy code">
              <svg class="copy-icon" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
              </svg>
              <svg class="check-icon" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display:none;color:#4ade80">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
              </svg>
            </button>
          `;

          const copyBtn = header.querySelector('.copy-btn');
          copyBtn.addEventListener('click', async () => {
            const code = pre.querySelector('code')?.textContent || pre.textContent || '';
            await navigator.clipboard.writeText(code);
            const copyIcon = header.querySelector('.copy-icon');
            const checkIcon = header.querySelector('.check-icon');
            copyIcon.style.display = 'none';
            checkIcon.style.display = 'block';
            setTimeout(() => {
              copyIcon.style.display = 'block';
              checkIcon.style.display = 'none';
            }, 2000);
          });

          wrapper.insertBefore(header, pre);
        });
      });
    </script>

    <style is:global>
      .code-block-wrapper {
        margin-bottom: 1rem;
        border-radius: 0.5rem;
        overflow: hidden;
        border: 1px solid #1e293b;
      }
      .code-block-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.5rem 1rem;
        background: #1e293b;
        border-bottom: 1px solid #334155;
      }
      .code-lang {
        font-size: 0.75rem;
        font-weight: 500;
        color: #94a3b8;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }
      .copy-btn {
        display: flex;
        padding: 0.375rem;
        color: #94a3b8;
        background: transparent;
        border: none;
        border-radius: 0.25rem;
        cursor: pointer;
        transition: all 0.15s;
      }
      .copy-btn:hover {
        color: white;
        background: #334155;
      }
      .code-block-wrapper pre {
        margin: 0 !important;
        border: none !important;
        border-radius: 0 !important;
      }
      .mermaid-diagram {
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        border: 1px solid #334155;
        border-radius: 0.75rem;
        padding: 1.5rem;
        margin: 1.5rem 0;
        overflow-x: auto;
        display: flex;
        justify-content: center;
      }
      .mermaid-diagram svg {
        max-width: 100%;
        height: auto;
      }
    </style>
  </body>
</html>
